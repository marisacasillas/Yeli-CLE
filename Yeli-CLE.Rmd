---
title             : "Early language experience in a Papuan village"
shorttitle        : "Early language experience in a Papuan village"

author: 
  - name          : "Marisa Casillas"
    affiliation   : "1"
    corresponding : yes    # Define only one corresponding author
    address       : "P.O. Box 310, 6500 AH Nijmegen, The Netherlands"
    email         : "Marisa.Casillas@mpi.nl"
  - name          : "Penelope Brown"
    affiliation   : "1"
  - name          : "Stephen C. Levinson"
    affiliation   : "1"

affiliation:
  - id            : "1"
    institution   : "Max Planck Institute for Psycholinguistics"

#author_note: |
#  Add complete departmental affiliations for each author here. Each new line herein must be indented, like this line.

abstract: |
  To be completed later.

keywords          : "Child-directed speech, linguistic input, non-WEIRD, vocal maturity, turn taking, interaction, Papuan"
wordcount         : "XXXXX (XXXX not including references)"

bibliography      : ["Yeli-CLE.bib"]

figsintext        : yes
figurelist        : no
tablelist         : no
footnotelist      : no
lineno            : yes
mask              : no

class             : "man"
output            : papaja::apa6_pdf #apa6_pdf or apa6_word
---

```{r load_packages, include=FALSE, echo=FALSE, warning=FALSE}
library(papaja)
library(ggplot2)
library(tidyverse)
library(viridis)
library(grid)
library(gridExtra)
library(lme4)
library(glmmTMB)
library(DHARMa)
library(bbmle)
library(broom.mixed)
library(lubridate)
source("0-Helper.R")
```

```{r analysis_presets, include=FALSE}
options(scipen=999)
data.path <- "transcripts/anon/" # text files exported from ELAN
metadata.path <- "metadata/"
plot.path <- "plots/" # output plots
shiny.input.path <- "shiny_input/"
shiny.input.img.path <- "www/"
ptcp.info.file <- paste0(metadata.path, "recording-info.csv")
samplelabels <- c("High activity  ", "Random  ")
col.sample.bu <- list(
  scale_fill_manual(labels=samplelabels, values=viridis(2)),
  scale_color_manual(labels=samplelabels, values=viridis(2)))
col.sample.bu3 <- list(
  scale_fill_manual(labels=samplelabels, values=viridis(3)),
  scale_color_manual(labels=samplelabels, values=viridis(3)))
rand.sample.dur <- 2.5
ext.sample.dur <- 5
peak.sample.dur <- 1
```

# Introduction {#intro}
In their first five years of life, children hear an extraordinary amount of language in a wide variety of interactional contexts. Tracking the distribution and characteristics of this linguistic input over the day, across age, and between children is a difficult task. Until recently, developmental language science has relied on short video recordings of caregiver-child interaction, at home or in the lab, to get a grasp on what kinds of language children typically hear. This has been a fruitful approach in teasing out individual and group-based differences in interactional style (REFS). However, short recordings are limited in their insight because they represent only a small slice of the child's language abilities and experiences (REFS).

Improved recording hardware and advances in speech technology have recently allowed us to use daylong recordings to get a peek into children's broader language landscapes. Daylong recordings are made with a device, usually positioned on the target child's chest, while that child freely navigates their social environment for most of a waking day (REFS). This style of audio recording has allowed researchers to track children's verbal language use across a range of activity and interlocutor contexts, yielding more representative and generalizable measures of their language environments (REFS). While daylong recording collections are typically too large for comprehensive transcription and annotation, a combination of automated tools, (REFS) sampling techniques (REFS), and standardized annotation approaches (REFS) can lead to rich, but efficiently-gained glimpses into the at-home language environment. However, properly collecting, processing, and archiving daylong data is not easily achieved and may not be well suited for a range of research questions (REFS). At time of writing, there are few options for capturing visual information across the day (but see REFS), limiting this method primarily to acoustic phenomena (REFS).

Daylong recording methods are still relatively new, and their reliability and predictive value for language development have not yet been fully established. For example, one collection of recordings made in the US Northwest suggests that there is so much variability across activities and days in basic talk characteristics (e.g., how much speech comes from what types of speakers) that researchers need several days of recordings before they can expect their input estimates to stabilize (Anderson & Fausey, in prep). Even if one can achieve a reliable estimate of a language environment measure (e.g., overhearable adult words per hour), how and why that estimate relates to deeper factors shaping the learning situation, including caregiving ideologies and language outcomes, is often indirect at best. Relatedly, meaningful differences between individual children may be minimized when averaging across the entirety of the day's high and low moments; it may well be that a few key interactions throughout the day provide sharper resolution on individual and group-based differences compared to whole-day averages.

Recent studies have directly investigated the effect of recording duration on caregiver speech, finding that short recordings display much denser, and somewhat different input than longer recordings [@bergelson2019day; @tamislemonda2017power]. Bergelson and colleagues [@bergelson2019day] analyzed the contexts of noun use encountered by 44 6- and 7-month-old children in the US in both hour-long at-home videos and comparable sub-samples of daylong recordings. They found that, while the videos tended to have very dense noun-related input and significantly more nouns embedded in questions, daylong samples contained more nearby speakers and more noun types (see [@bergelson2019day] for the full range of differences). Frequently heard nouns were more consistent across families in the daylong data compared to the video data, suggesting that daylong data may more more robustly capture stable, group-level similarities in child-proximal speech. Interestingly, children heard more dense noun input during their 'peak' hour for the day compared to the video, which also highlights peak interactions from daylong recordings as a promising compromise between ecological validity and concentrated measures of language environment and development. Importantly, a child's relative rank across a range of speech environment measures may be stable across recording contexts, at least for US children [@tamislemonda2017power]. Based on these findings, one could infer that at-home short recordings are influenced by some (but not all) of the same underlying factors that drive language patterns during daylong recordings (e.g., caregiver ideologies about child development, child responsiveness, household composition).

Studies of children growing up in two indigenous Mayan communities of Southern Mexico (Tseltal and Yucatec Mayan) suggest that short and long recordings may yield substantial differences in how the speech environment is characterized (REFS). Previous studies on these communities have tended to use ethnographic and microanalytic analyses of short interactions to examine the character of children's speech environments. They have found that caregivers shape infants' and young children's worlds such that the children learn to attend to what is going on around them rather than expecting to be the center of attention (REFS). Consistent with this goal, direct talk to infants, particularly from adults, is rare until children themselves begin to elicit responses from others (REFS). Because young children are often cared for by older siblings and cousins, a substantial portion of talk to young children was also expected to come from other children (REFS). Similar observations have been reported for multiple other distinct (but ethnolinguistically related) communities in the region (REFS). Following up on this ethnographic work, Shneidman (REFS) used short videos of interaction to conduct a quantitative, longitudinal study of the speech young Yucatec children heard. She found that interactional patterns aligned well with observations in previous work in that community: infants were rarely spoken to at first, but their language input increased enormously with age, mostly due to an influx of speech from other children (REFS). However, when Casillas and colleagues (REFS) used daylong recordings with a Tseltal Mayan community, where a similar caregiver interactional style has been described previously on the basis of short videos, the pattern of findings diverged from expectations. In brief, they found that infants and young children were indeed spoken to rarely, but that there was no increase in speech input with age and the majority of speech came from adult women, even when children were old enough to independently follow their older siblings and cousins around the house. These divergent results betweeh daylong and short video recordings don't imply that the latter is wrong, only that it is not representative with respect to the child's language experience over an entire day.

These findings do raise an important issue faced by developmental psychology as it continues to expand the study of child language to more diverse speech communities: when researchers are not members of the community they are studying, it is difficult to know a priori what is typical, representative, or meaningful in children's language experience. By observing as much speech as possible in a context as ecologically valid as possible and by sampling, annotating, and analyzing the data on the basis of the most established development measures we have, researchers using daylong recordings might hope to approach this issue without first needing to conduct deep ethnographic studies in the community on caregiving practices and ideologies around language use and language development (REFS). When studying members of our own cultural group, we can bridge between simple, observable behaviors and rich interpretations of, thereby expanding our explanatory model beyond the measures directly analyzed (e.g., why child-directed talk might relate to faster vocabulary development). We cannot hope to gain such enriched understandings cross-culturally without ethnographic work; and in the absence of such work we must accept that there may be a dissociation between how we have traditionally understood an operationalized language behavior (e.g., child-directed speech) and what drives the use and form of that behavior in a given community or interactional context (e.g., pedagogical concerns, entertainment of the caregiver, getting the child to assist). Until there are trained researchers working on this topic who were born and raised as members of these communities (what we should be trying to cultivate for the longer term) this is a quandary we will continue to face.

Pairing ethnographic work with broader-scope studies of children's language environments may be the most fruitful way to ensure that their speech environments and speech development are captured well enough to propose and test meaningful theories cross-culturally. These two methods have complementary roles to play in exploring the landscape of at-home language, and neither should be taken to reflect the 'true' language input for a given child; after all, in the example of Tseltal above, many interactions with infants during the daylong recordings came during moments where visitors using a video camera, or even other community members, would not typically be invited (e.g., after the parent was roused by the child, who was waking from an afternoon sleep). If we want to encourage more work on small-scale and/or understudied language learning contexts, it will be important to continue establishing how different methods of measuring the input impact the conclusions that are likely to be made.

In this study we present analyses of daylong recordings from a small-scale indigenous group, on Rossel Island, Papua New Guinea (PNG), in which prior ethnographic work has painted a clear picture of early caregiver-child interaction: child-centric, face-to-face interaction from the first days of infancy. Based on the prior ethnographic work, detailed below, we made four predictions about children's speech environments. First, we predicted that children on Rossel Island would hear frequent child-directed speech from a wide variety of caregiver types throughout the day. Second, given how frequently they are passed between caregivers, we expected to see weaker effects of the subsistence farming schedule on Rossel children's input than has been found in other societies (Casillas et al., forthcoming). Third, as children get older, we expected to see a large increase in the proportion of child-directed speech coming from other children (see also Shneidman REFS). Fourth, we expected a large quantity of other-directed speech around them, given the large number of family numbers typically present. Based on prior work with daylong recordings with both Western and non-Western small-scale populations, we additionally expected (a) no age-related increase in child-directed speech (Scaff, Casillas, Bergelson, REFS), (b) an age-related decrease in other-directed speech (Casillas, Bergelson, REFS), and (c) that children's input would be non-uniformly distributed over the day [@blasiIPhuman; @abney2017time] such that interactional peaks present a much denser view of their input (Casillas et al., forthcoming), similar to that observed in short videos.

In what follows we will review the ethnographic work done with this community previously, describe our methods for following up on these findings with daylong recordings, present the current findings, and discuss the differences that arose. This study was completed as part of a larger comparative project focusing on children's speech environments and linguistic development at two sites: the Tseltal Mayan community mentioned above (Casillas et al., forthcoming) and this Rossel Island community. Therefore all methods for annotation and analysis in this study parallel those reported elsewhere for Tseltal Mayan children's speech environments (Casillas, Brown, & Levinson, forthcoming).

# Method {#methods}
## Corpus {#methods-dataset}
The participants in this study live in a collection of small hamlets on north-eastern Rossel Island, approximately 250 nautical miles off the southern tip of mainland Papua New Guinea. The traditional language of Rossel Island is Yélî Dnye, a presumed Papuan isolate, which features a phonological inventory and set of grammatical features that are unlike any other in the (predominantly Austronesian) languages of the region. Rosselers are skilled farmers, cultivating taro, sweet potato, manioc, yam, coconut, and more for their daily subsistence, with protein coming from fishing and (occasionally) slaughtering pigs or local animals. Most children on Rossel Island grow up speaking Yélî Dnye monolingually at home, beginning to learn English as a second language once they begin school around age 7 or 8. Children grow up in patrilocal household clusters (i.e., their family and their father's brothers families), usually arranged such that there is some shared open space between households. 

During their waking hours, infants are typically carried in a caregiver's arms as they go about daily activities. Infants, even very young ones, are frequently passed between different family members (male and female, young and elderly) throughout the day, returning to the mother to suckle when hungry. The arc of a typical day for an infant might include waking, being dressed and fed, then a mix of (a) spending time with nearby adults or older children as they walk around socializing and completing tasks with others and (b) more feeding, perhaps followed by short bouts of sleep in the late morning and afternoon, usually with the mother. Afternoon meals are cooked from around 15:00 onward, with another meal time and more socializing at home before resting for the night. Starting around age two or three, children also begin to spend a lot of their time in large, independent child playgroups involving up to 10 or more cousins at a time who freely travel near and around the village searching for nuts and fruits, bathing in nearby rivers, and engaging in group games (e.g., tag, pretend play, etc.).

Interaction with infants and young children on Rossel Island is initiated by women, men, girls, and boys alike in a face-to-face, contingency-seeking, and affect-laden style (Brown REFS). Children are considered a shared responsibility, but also a source of joy and entertainment for the wider network of caregivers in their community. In her prior ethnographic work, Brown details some ways in which interactants make bids for joint attention and act as if the infant can understand what is being said (REFS). Infants pick up on this pattern of caregiving, intiating interactions with others twice as frequently as Tseltal children, who are encouraged instead to be observers of the interactions going on around them (Brown 2011 REFS). At the same time, Brown (REFS) documents how Rossel caregivers encourage early independence in their children, observing their autonomy in choosing what to do, wear, eat, and say while finding other ways to promote pro-social behavior (e.g., praise; REFS). Overall, Rossel Island could be characterized as a child-centered language environment (Ochs & Schieffelin 1984; REFS but see Brown & Casillas REFS), in which children, even very young ones, are considered interactional and conversational partners whose interests are allowed to shape the topic and direction of conversation.

We were interested to investigate the language environment of children acquiring Yélî Dnye because prior ethnographic work had suggested that child-directed speech is highly frequent in this community, from mothers and other adult caregivers, but also from other children. Therefore we were interested in understanding how children's input environment influenced their acquisition of this language with all its rare structures.

The data presented here come from Rossel Island subset of the Casillas HomeBank Corpus [@Casillas-HB], a collection of raw daylong recordings and more from over 100 children under age four growing up on Rossel Island and in the Tseltal Mayan community described elsewhere (Casillas et al. forthcoming). The Rossel Island subcorpus was collected in 2016 and includes daylong audio recordings and experimental data from 57 children born to XX mothers. On average, the target children in these recordings had X--X younger siblings (mean = X; median = X) and X--X older siblings (mean = X; median = X); most participating parents were on the younger end of parents in the community (mothers: mean = XX years; median = XX; range = XX--XX and fathers: mean = XX; median = XX; range = XX---XX). Based on our demographic data we estimate that mothers are typically XX years old when they give birth to their first child (median = XX; range = XX--XX) with an average inter-child interval of X years (median = X; range = X--X). Notably, however, we received several reports, including from nursing staff at the local health clinic, that mothers now are having children younger and closer together than in generations past. Household size, defined here as the number of people sharing kitchen and sleeping areas on a daily basis, ranged between X and XX (mean = X; meadian = X). Households are clustered into small hamlets which form a wider group of communal caregivers and playmates. The hamlets themselves are clustered together into broader patches of patrilocal residents. The average hamlet in our corpus comprises X households (median = X; range = X--X); assuming an average of X children under age seven (i.e., not schooling) and X adults per household, we estimate that there are between XX and XX children and between XX and XX adults present throughout the day, not including visitors, visits to neighboring hamlets or other nearby resident areas. Therefore, while XX% of the target children in our corpus are first born to their mothers, they are immediately incorporated into a much larger pool of young children whose care is divided among numerous caregivers. Among our participating families, most mothers had finished primary school (XX%; X years of education) or secondary school (XX%; X years of education), with a few having completed preparatory school (XX%; X years of education) or beyond (XX%; X years of education). Only XX% of mothers had less than a primary school education. Similarly, most fathers had finished primary school (XX%; X years of education) or secondary school (XX%; X years of education), with a few having completed preparatory school (XX%; X years of education) or beyond (XX%; X years of education), with only XX% having less than a primary school education. To our knowledge at the time of recording, all but two children were typically developing; one showed signs of significant language delay and one showed signs of multiple developmental delay (motor, language, intellectual), both children's delays were consistently observed in follow-up trips in 2018 and 2019.

Dates of birth for children were initially gotten from parent report. We were able to verify the vast majority of birth dates using the records at the island health clinic. Because not all mothers give birth at the clinic and because dates are written by hand, some births are not recorded, are inaccurately recorded, or otherwise significantly diverge from what the parents report. In these cases we gathered information from as many sources as possible and followed up with the families, often using the dates of neighboring children born around the same time to home in on the correct date.

The data we present come from 7--9-hour recordings of a waking day at home for the child. Children wore the recording device, which was an elastic vest containing a small stereo audio recorder (Olympus WS-832 or WS-853) and a miniature camera that captured photos of the child's frontal view at a fixed interval (every 15 seconds; Narrative Clip 1). The camera was outfitted with a fisheye lens that, while distorting the images, allowed us to capture 180 degrees of children's frontal view. This technique allows us to use daylong recordings while also partially getting around the traditional sacrifice of no visual context, thereby increasing ease and reliability of our transcrition and annotation. However, because the camera and recorder are separate devices, we had to synchronize them manually after the recordings were made. To do this, we used an external wristwatch to record the current time at start of recording on each device individually, with accuracy down to the second (photographed by the camera and spoken into the recorder). The camera timestamps each photo such that we can calculate the number of seconds that have elapsed between each one. These timestamps can be used with the cross-device time synchronization cue to create photo-linked audio files of each recording, which we then format as video files (see https://github.com/marisacasillas/Weave for post-processing scripts and more information). The informed consent process used with participants, as well as data collection and storage, were conducted in accordance with ethical guidelines approved by the Radboud University Social Sciences Ethics Committee.

## Data selection and annotation {#methods-samples}
From the daylong recordings of XX Rossel children, we selected 10 representative children between ages 0;0 and 3;0 for transcription and analysis in the current study. The 10 children were selected to be spread between the target age range (0;0--3;0) while also representing a range of typical maternal education levels found in the community and  being evenly split between male and female children (see also ACLEW REFS). For each child we then selected a series of non-overalapping sub-clips from the day for transription in the following order: nine randomly-selected 2.5-minute clips, five manually-selected 'peak' turn-taking activity 1-minute clips, five manually-selected 'peak' vocal activity 1-minute clips, and one manually-selected 5-minute expansion of the best one-minute clip, for a total of 37.5 minutes of transcribed audio for each child (6.25 audio hours in total). The criteria for manual clip selection are identical to those described for the parallel study on Tseltal by Casillas and colleagues (forthcoming).

We were limited to selecting sub-clips from 10 children for analysis because of the time-intensive nature of transcribing these naturalistic data; 1 minute of audio typically took us approximately 60--70 minutes to be segmented into utterances, transcribed, annotated, and loosely translated into English (~400 hours total). Given that Yélî Dnye is nearly exclusively spoken on Rossel Island, where there is no electricity and unreliable access to mobile data, transcription could only be completed over the course of three 4--6 week visits by our research group to the island in 2016, 2018, and 2019.

We used the ACLEW Annotation Scheme (REFS) in ELAN (ELAN REFS) to transcribe and annotate all hearable speech---both near and distant---in the clips. We first segmented out the utterances and ascribed them to individual speakers (e.g., older brother, mother, aunt, etc.). We then annotated the vocal maturity of each utterance produced by the target child (non-canonical babble/canonical babble/single word/multi-word/unsure) and annotated the addressee of all speech from other speakers (addressed to the target child/one or more other children/one or more adults/a mix of adults and children/any animal/other/unsure). Transcription and annotation was done together by the first author and one of three community members (all native speakers of Yélî Dnye). The community-based research assistants personally knew all the families in the recordings, and were able to use their own experience, the discourse context, and information from the accompanying photos in reporting what was said and to whom speech was addressed for each utterance. Detailed manuals and self-guided training materials, including a 'gold standard test' for this annotation scheme can be found at URL (REFS).

In what follows we first analyze the nine randomly selected 2.5-minute clips from each child to establish a baseline view of their speech environment, focusing on the effects of child age, time of day, household size, and number of speakers on the rate of child-directed and overhearable speech present. Next, we repeat these analyses, focusing instead only on the turn-taking clips to gain a view of the speech environment as it appears during the peak interactions for the day. This latter set of analyses may more closely mirror results from prior ethnographic work. To demonstrate typical development in this context we briefly present one measure of language development: a coarse trajectory mapping children's use of babble, first words, and multi-word utterances. Finally, we wrap up by integrating the divergent perspectives on Yélî children's speech environment across methods and relating these findings to the larger literature on child-directed speech and its role in language development.

## Statistical models
We conducted all analyses in R, using the glmmTMB package to run generalized linear mixed-effects regressions on our dependent measures [@brooks2017modeling; @R-base]. We used ggplot2 to generate all plots [@R-ggplot2]. The dataset and scripts used to generate this manuscript and analyses can be found at https://github.com/marisacasillas/Yeli-CLE. As explained in previous work (REFS Casillas et al. forthcoming, Bunce et al, in prep), child-directed and overhearable speech minutes per hour are naturally restricted to non-negative (0--infinity) values, causing the distributional variance of those measures to become non-gaussian (positively skewed). We therefore use negative binomial regressions, which can better fit non-negative, overdispersed data [@brooks2017modeling; @smithson2013generalized]. In cases when there were extra zeroes in the data (e.g., no hearable speech because the child was alone), we added a zero-inflation model to the regression. This method creates two models: (a) a binary model to evaluate the likelihood of the variable's presence (e.g., no vs. some directed speech) and (b) a count model of the variable (e.g., '3' vs. '5' minutes of directed speech), with an extra parameter indicating data dispersion. More conventional, gaussian linear mixed-effects regressions with logged dependent variables are available in the Supplementary Materials. The results of those alternative models are qualitatively similar to what we report here.

# Results {#results}
<!--Our model predictors were as follows: child age (months), household size (number of people), and number of non-target-child speakers present in that clip, all centered and standardized, plus time of day at the start of the clip (as a factor; "morning" = up until 11:00; "midday" = 11:00--13:00; and "afternoon" = 13:00 onwards). In addition, the model included two-way interactions between child age and: (a) the number of speakers present, (b) household size, and (c) time of day. We also added a random effect of child. For the zero-inflation models, we included the number of speakers present. We only report significant effects in the main text; full model outputs are available in the Supplementary Materials.-->

```{r prepare_data, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# Read in annotation files
files <- list.files(path=data.path,pattern="*.txt")
all.data <- data.frame()
for (i in 1:length(files)) {
  newfile <- read_csv(paste0(data.path, files[i]),
                      col_types = cols(val = col_character()))
  newfile$aclew_child_id <- unlist(strsplit(files[i], '\\.'))[1]
  all.data <- rbind(all.data, newfile)
}
all.data$row <- c(1:nrow(all.data))

# Read in supplementary data
ptcp.info <- read_csv(ptcp.info.file, col_types = cols())
ptcp.info$aclew_child_id <- as.character(ptcp.info$aclew_child_id)

# Extract and convert start time of each sample
rec.time.info <- ptcp.info %>%
  select(aclew_child_id, start_of_wav, length_of_wav) %>%
  mutate(
    start.hh = substr(start_of_wav, 1, 2),
    start.mm = substr(start_of_wav, 4, 5),
    start.ss = substr(start_of_wav, 7, 8),
    start_of_wav.ms = period_to_seconds(hms(start_of_wav))*1000,
    stop_of_wav.ms = start_of_wav.ms + length_of_wav*1000,
    stop_of_wav = paste(
      str_pad(hour(seconds_to_period(
        stop_of_wav.ms/1000)), 2, "left", pad = "0"),
      str_pad(minute(seconds_to_period(
        stop_of_wav.ms/1000)), 2, "left", pad = "0"),
      str_pad(second(seconds_to_period(
        stop_of_wav.ms/1000)), 2, "left", pad = "0"), sep = ":"),
    length_of_wav.ms = length_of_wav*1000) %>%
  rename(length_of_wav.s = length_of_wav) %>%
  select(aclew_child_id,
         start_of_wav, stop_of_wav, length_of_wav.s,
         start_of_wav.ms, stop_of_wav.ms, length_of_wav.ms,
         start.hh, start.mm, start.ss)

seg.info <- filter(all.data, tier == "code") %>%
  select(-tier, -speaker, -row) %>%
  left_join(rec.time.info) %>%
  mutate(
    start.ms = start_of_wav.ms + start,
    start.sec = start.ms/1000,
    start.hhmmss = paste(
      str_pad(hour(seconds_to_period(start.sec)),
        2, "left", pad = "0"),
      str_pad(minute(seconds_to_period(start.sec)),
        2, "left", pad = "0"),
      str_pad(second(seconds_to_period(start.sec)), 2,
        "left", pad = "0"), sep = ":"),
    start.hr = start.ms/3600000)

# Add mean and sd values for participant-level predictors to ptcp.info
ptcp.info <- ptcp.info %>%
  mutate(
    tchiyr.m = mean(age_mo_round),
    motyr.m = mean(mat_age),
    nsb.m = mean(number_older_sibs),
    hsz.m = mean(household_size),
    tchiyr.sd = sd(age_mo_round),
    motyr.sd = sd(mat_age),
    nsb.sd = sd(number_older_sibs),
    hsz.sd = sd(household_size)
    )

# Merge participant and segment info to the main data table
codes <- filter(all.data, tier == "code")

all.data <- all.data %>%
  filter(speaker != "") %>%
  left_join(ptcp.info, by = "aclew_child_id") %>%
  mutate(segment = "", sample = "",
         sample_type = "", clip_dur = 0)

for (i in 1:nrow(codes)) {
  rec <- codes$aclew_child_id[i]
  seg <- as.character(codes$val[i])
  seg.on <- codes$start[i]
  seg.off <- codes$stop[i]
  seg.idx <- which(all.data$aclew_child_id == rec &
                     all.data$start < seg.off &
                     all.data$stop > seg.on)
  all.data$segment[seg.idx] <- seg
  all.data$clip_dur[seg.idx] <- codes$dur[i]
}

# Remove utterances that occur outside of the annotated clips
all.data$sample[which(
  grepl('^random', all.data$segment))] <- "random"
all.data$sample[which(
  grepl('tt', all.data$segment))] <- "turn-taking"
all.data$sample[which(
  grepl('va', all.data$segment))] <- "vocal-activity"
all.data <- filter(all.data, sample != "")
# shorten utterance bouncaries that extend outside of the annotated clips
# NOTE: because of the split extensions with the same names
# we have to be cautious (e.g., if there are two 'ext-va-1' codes)
# for a given recording
seg.on.off <- seg.info %>%
  select(aclew_child_id, start, stop, val) %>%
  rename(clip_start = "start", clip_stop = "stop", segment = val) %>%
  mutate(clip_dur = clip_stop - clip_start)
for (i in 1:nrow(seg.on.off)) {
  over.left.edge.idx <- which(all.data$aclew_child_id == seg.on.off$aclew_child_id[i] &
                          all.data$start < seg.on.off$clip_stop[i] &
                          all.data$stop > seg.on.off$clip_start[i] &
                          all.data$start < seg.on.off$clip_start[i])
  over.right.edge.idx <- which(all.data$aclew_child_id == seg.on.off$aclew_child_id[i] &
                          all.data$start < seg.on.off$clip_stop[i] &
                          all.data$stop > seg.on.off$clip_start[i] &
                          all.data$stop > seg.on.off$clip_stop[i])
  if (length(over.left.edge.idx) > 0) {
    all.data$start[over.left.edge.idx] <- seg.on.off$clip_start[i]
  }
  
  if (length(over.right.edge.idx) > 0) {
    all.data$stop[over.right.edge.idx] <- seg.on.off$clip_stop[i]
  }
}

# Add basic segment info to all.data
all.data <- all.data %>%
  left_join(seg.on.off) %>%
  mutate(
    sample_type = case_when(
      grepl("^ran", segment) ~ "random",
      grepl("^ext", segment) ~ "extension",
      grepl("^tt", segment) ~ "turn-taking",
      grepl("^va", segment) ~ "vocal-activity"
    ),
    segment_dur = case_when(
      sample_type == "random" ~ rand.sample.dur,
      sample_type == "extension" ~ ext.sample.dur,
      sample_type == "turn-taking" |
        sample_type == "vocal-activity" ~ peak.sample.dur
    ))


# Add in segment start time
mini.clip.info <- select(seg.info, c("aclew_child_id", "val",
  "start.hhmmss", "start.sec", "start.hr", "start")) %>%
  rename("segment" = "val", "clip.start.hhmmss" = "start.hhmmss",
    "clip.start.sec" = "start.sec", "clip.start.hr" = "start.hr",
    "clip_start" = "start")
all.data <- all.data %>%
  left_join(mini.clip.info)
```

```{r demog_table_prep, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
sample.demog <- ptcp.info %>%
  mutate(mat_age_rd = as.integer(round(mat_age, 0)),
         fat_age_rd = as.integer(round(fat_age, 0)),
         hszrd = as.integer(round(household_size + 1, 0))) %>%
  select(age_childes, child_sex, mat_age_rd, mat_ed, hszrd) %>%
  arrange(age_childes) %>%
  rename("Age" = age_childes, "Sex" = child_sex,
         "Mother's age" = mat_age_rd, "Level of maternal education" = mat_ed,
         "People in household" = hszrd)
```

```{r tab1, echo=FALSE, results='asis', message=FALSE, warning=FALSE}
apa_table(sample.demog, caption="Demographic overview of the 10 children whose recordings are sampled in the current study, including from left to right: child's age (years;months.days); child's sex (M/F); mother's age (years); level of maternal education (none/primary/secondary/preparatory/university); and the number of people living in the child's household.")
```

```{r fig2, echo=FALSE, fig.cap="Recording duration (black line) and sampled clips (colored boxes) for each of the 10 recordings analyzed, sorted by child age in months.", message=FALSE, warning=FALSE, fig.height=4}
ptcp.info <- ptcp.info %>%
  arrange(age_mo_round) %>%
  mutate(order = seq(1:10))

used.clips <- seg.info %>%
  mutate(
    alt.seg.name = gsub("ext-", "", val)) %>%
  group_by(aclew_child_id, alt.seg.name) %>%
  summarize(start.hhmmss = min(start.hhmmss),
            start.hr = min(start.hr),
            start.rec.hr = min(start_of_wav.ms)/3600000,
            end.rec.hr = min(stop_of_wav.ms)/3600000,
            clip.dur = sum(dur)/60000) %>%
  rename(segment = alt.seg.name) %>%
  mutate(sample.type = case_when(
      grepl('random', segment) ~ "Random",
      grepl('tt', segment) ~ "Turn taking",
      grepl('va', segment) ~ "Vocal activity")) %>%
  left_join(ptcp.info)
used.clips$sample.type = factor(used.clips$sample.type,
                                levels = c(
                                  "Random", "Turn taking",
                                  "Vocal activity"))
  
clip.distribution <- ggplot(data = used.clips) +
  geom_segment(data = filter(used.clips, segment == "random-1"),
               aes(x = start.rec.hr, y = order,
                   xend = end.rec.hr, yend = order)) +
  geom_segment(aes(x = start.hr, y = order,
                   xend = start.hr + clip.dur/60, yend = order,
                   color = sample.type), size = 3) +
  theme_apa() +
  theme(legend.position = "bottom") +
  scale_x_continuous(breaks = 7:21) +
  scale_y_continuous(breaks = 1:10, labels = ptcp.info$age_mo_round) +
  ylab("Child age (mo)") + xlab("Time of day (hr)") + labs(color = "Sample type") +
  scale_color_manual(values = c(viridis(3)[1], viridis(3)[2], "blue"))
clip.distribution
```

```{r quantity_prep, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# RANDOM
# Get min/hr speech measures
n.unique.rand.segs <- length(unique(
  all.data$segment[grepl("random", all.data$segment)]))
n.unique.recs <- length(unique(all.data$aclew_child_id))
all.rand.segments <- tibble(
  aclew_child_id = rep(unique(all.data$aclew_child_id),
                n.unique.rand.segs),
  segment = rep(unique(all.data$segment[grepl(
    "random", all.data$segment)]),
                n.unique.recs))
# XDS
xds.per.seg.rand <- all.data %>%
  filter(sample == "random" & speaker != "CHI" &
           grepl("xds@", tier)) %>%
  group_by(aclew_child_id, segment, segment_dur) %>%
  summarise(xds_min = round(sum(dur)/60000,3)) %>%
  full_join(all.rand.segments, by = c("aclew_child_id", "segment")) %>%
  replace_na(list(segment_dur = rand.sample.dur, xds_min = 0)) %>%
  mutate(xds_mph = (xds_min/segment_dur)*60) %>%
  arrange(aclew_child_id, segment)
# ODS
ods.per.seg.rand <- all.data %>%
  filter(sample == "random" & speaker != "CHI" &
           grepl("xds@", tier) & val != "T") %>%
  group_by(aclew_child_id, segment, segment_dur) %>%
  summarise(ods_min = round(sum(dur)/60000,3)) %>%
  full_join(all.rand.segments, by = c("aclew_child_id", "segment")) %>%
  replace_na(list(segment_dur = rand.sample.dur, ods_min = 0)) %>%
  mutate(ods_mph = (ods_min/segment_dur)*60) %>%
  arrange(aclew_child_id, segment)
# TDS
tds.per.seg.rand <- all.data %>%
  filter(sample == "random" & speaker != "CHI" &
           grepl("xds@", tier) & val == "T") %>%
  group_by(aclew_child_id, segment, segment_dur) %>%
  summarise(tds_min = round(sum(dur)/60000,3)) %>%
  full_join(all.rand.segments, by = c("aclew_child_id", "segment")) %>%
  replace_na(list(segment_dur = rand.sample.dur, tds_min = 0)) %>%
  mutate(tds_mph = (tds_min/segment_dur)*60) %>%
  arrange(aclew_child_id, segment)
# All CDS
cds.per.seg.rand <- all.data %>%
  filter(sample == "random" & speaker != "CHI" &
           grepl("xds@", tier) & (val == "T" | val == "C")) %>%
  group_by(aclew_child_id, segment, segment_dur) %>%
  summarise(cds_min = round(sum(dur)/60000,3)) %>%
  full_join(all.rand.segments, by = c("aclew_child_id", "segment")) %>%
  replace_na(list(segment_dur = rand.sample.dur, cds_min = 0)) %>%
  mutate(cds_mph = (cds_min/segment_dur)*60) %>%
  arrange(aclew_child_id, segment)
# Number of speakers per clip
spkrs.per.seg.rand <- all.data %>%
  filter(sample == "random" & speaker != "CHI" &
           !(grepl("@", tier))) %>%
  group_by(aclew_child_id, segment) %>%
  summarise(n_spkrs_clip = length(unique(speaker)))
# All together
quantity.rand <- xds.per.seg.rand %>%
  full_join(ods.per.seg.rand, by = c("aclew_child_id", "segment", "segment_dur")) %>%
  full_join(tds.per.seg.rand, by = c("aclew_child_id", "segment", "segment_dur")) %>%
  full_join(cds.per.seg.rand, by = c("aclew_child_id", "segment", "segment_dur")) %>%
  left_join(spkrs.per.seg.rand, by = c("aclew_child_id", "segment")) %>%
  left_join(dplyr::select(seg.info, c("aclew_child_id", "val", "start.hr")),
            by = c("aclew_child_id" = "aclew_child_id", "segment" = "val")) %>%
  full_join(ptcp.info, by = "aclew_child_id") %>%
  replace_na(list(xds_min = 0, xds_mph = 0,
                  tds_min = 0, tds_mph = 0,
                  cds_min = 0, cds_mph = 0,
                  n_spkrs_clip = 0)) %>%
  mutate(prop_tds = tds_min/xds_min)
  # Don't replace NAs with 0s in this case; proportion is not meaningful w/o any speech
quantity.rand.bychild <- quantity.rand %>%
  group_by(aclew_child_id) %>%
  summarise(
    xds_min = mean(xds_min),
    xds_mph = mean(xds_mph),
    ods_min = mean(ods_min),
    ods_mph = mean(ods_mph),
    tds_min = mean(tds_min),
    tds_mph = mean(tds_mph),
    cds_min = mean(cds_min),
    cds_mph = mean(cds_mph),
    prop_tds = mean(prop_tds, na.rm = TRUE),
    m_n_spkrs = mean(n_spkrs_clip)) %>%
  full_join(ptcp.info, by = "aclew_child_id")

# Get xds and tds min/hr by speaker type
all.data$SpkrAge <- "Not known"
all.data$SpkrAge[grepl("FA|MA|UA", all.data$speaker)] <- "Adult"
all.data$SpkrAge[grepl("FC|MC|UC", all.data$speaker)] <- "Child"
all.rand.segments.sa <- tibble(
  aclew_child_id = rep(unique(all.data$aclew_child_id),
                2*n.unique.rand.segs),
  segment = rep(unique(all.data$segment[grepl("random", all.data$segment)]),
                2*n.unique.recs),
  SpkrAge = c(rep("Adult", (n.unique.rand.segs * n.unique.recs)),
              rep("Child", (n.unique.rand.segs * n.unique.recs))))

# Add in speaker sex
all.data$SpkrSex <- "Not known"
all.data$SpkrSex[grepl("FA|FC|FU", all.data$speaker)] <- "Female"
all.data$SpkrSex[grepl("MA|MC|MU", all.data$speaker)] <- "Male"
all.rand.segments.age.sx <- tibble(
  aclew_child_id = rep(unique(all.data$aclew_child_id),
                4*n.unique.rand.segs),
  segment = rep(unique(all.data$segment[grepl("random", all.data$segment)]),
                4*n.unique.recs),
  SpkrAge = c(rep("Adult", (n.unique.rand.segs * n.unique.recs)),
              rep("Child", (n.unique.rand.segs * n.unique.recs)),
              rep("Adult", (n.unique.rand.segs * n.unique.recs)),
              rep("Child", (n.unique.rand.segs * n.unique.recs))),
  SpkrSex = c(rep("Female", (n.unique.rand.segs * (2 * n.unique.recs))),
              rep("Male", (n.unique.rand.segs * (2 * n.unique.recs)))))

# XDS
xds.per.seg.rand.sa <- all.data %>%
  filter(sample == "random" & speaker != "CHI" &
      SpkrAge != "Not known" & grepl("xds@", tier)) %>%
  group_by(aclew_child_id, SpkrAge, segment, segment_dur) %>%
  summarise(xds_min.sa = round(sum(dur)/60000,3)) %>%
  full_join(all.rand.segments.sa,
    by = c("aclew_child_id", "segment", "SpkrAge")) %>%
  replace_na(list(segment_dur = rand.sample.dur, xds_min.sa = 0)) %>%
  mutate(xds_mph.sa = (xds_min.sa/segment_dur)*60) %>%
  arrange(aclew_child_id, segment, SpkrAge)
# ODS
ods.per.seg.rand.sa <- all.data %>%
  filter(sample == "random" & speaker != "CHI" &
      SpkrAge != "Not known" & grepl("xds@", tier) & val != "T") %>%
  group_by(aclew_child_id, SpkrAge, segment, segment_dur) %>%
  summarise(ods_min.sa = round(sum(dur)/60000,3)) %>%
  full_join(all.rand.segments.sa,
    by = c("aclew_child_id", "segment", "SpkrAge")) %>%
  replace_na(list(segment_dur = rand.sample.dur, ods_min.sa = 0)) %>%
  mutate(ods_mph.sa = (ods_min.sa/segment_dur)*60) %>%
  arrange(aclew_child_id, segment, SpkrAge)
# TDS
tds.per.seg.rand.sa <- all.data %>%
  filter(sample == "random" & speaker != "CHI" &
      SpkrAge != "Not known" & grepl("xds@", tier) & val == "T") %>%
  group_by(aclew_child_id, SpkrAge, segment, segment_dur) %>%
  summarise(tds_min.sa = round(sum(dur)/60000,3)) %>%
  full_join(all.rand.segments.sa,
    by = c("aclew_child_id", "segment", "SpkrAge")) %>%
  replace_na(list(segment_dur = rand.sample.dur, tds_min.sa = 0)) %>%
  mutate(tds_mph.sa = (tds_min.sa/segment_dur)*60) %>%
  arrange(aclew_child_id, segment, SpkrAge)
# All CDS
cds.per.seg.rand.sa <- all.data %>%
  filter(sample == "random" & speaker != "CHI"
    & SpkrAge != "Not known" & grepl("xds@", tier) &
      (val == "T" | val == "C")) %>%
  group_by(aclew_child_id, SpkrAge, segment, segment_dur) %>%
  summarise(cds_min.sa = round(sum(dur)/60000,3)) %>%
  full_join(all.rand.segments.sa,
    by = c("aclew_child_id", "segment", "SpkrAge")) %>%
  replace_na(list(segment_dur = rand.sample.dur, cds_min.sa = 0)) %>%
  mutate(cds_mph.sa = (cds_min.sa/segment_dur)*60) %>%
  arrange(aclew_child_id, segment, SpkrAge)
# Number of speakers per clip
spkrs.per.seg.rand.sa <- all.data %>%
  filter(sample == "random" & speaker != "CHI" &
      SpkrAge != "Not known" & !(grepl("@", tier))) %>%
  group_by(aclew_child_id, SpkrAge, segment) %>%
  summarise(n_spkrs_clip = length(unique(speaker)))
# All together
quantity.rand.sa <- xds.per.seg.rand.sa %>%
  full_join(ods.per.seg.rand.sa, by = c("aclew_child_id", "SpkrAge",
                                        "segment", "segment_dur")) %>%
  full_join(tds.per.seg.rand.sa, by = c("aclew_child_id", "SpkrAge",
                                        "segment", "segment_dur")) %>%
  full_join(cds.per.seg.rand.sa, by = c("aclew_child_id", "SpkrAge",
                                        "segment", "segment_dur")) %>%
  full_join(dplyr::select(quantity.rand, c("aclew_child_id", "segment", "tds_min")),
            by = c("aclew_child_id", "segment")) %>%
  full_join(spkrs.per.seg.rand.sa, by = c("aclew_child_id", "SpkrAge", "segment")) %>%
  left_join(dplyr::select(seg.info, c("aclew_child_id", "val", "start.hr")),
            by = c("aclew_child_id" = "aclew_child_id", "segment" = "val")) %>%
  full_join(ptcp.info, by = "aclew_child_id") %>%
  replace_na(list(xds_min.sa = 0, xds_mph.sa = 0,
                  ods_min.sa = 0, ods_mph.sa = 0,
                  tds_min.sa = 0, tds_mph.sa = 0,
                  cds_min.sa = 0, cds_mph.sa = 0,
                  n_spkrs_clip = 0)) %>%
  mutate(prop_tds.sa = tds_min.sa/xds_min.sa,
         prop_sa.tds = tds_min.sa/tds_min)
  # Don't replace NAs with 0s in this case; proportion is not meaningful w/o any speech


# NON-RANDOM
# Get min/hr speech measures
all.nonrand.segments <- seg.info %>%
  filter(!(grepl("random", val))) %>%
  select(aclew_child_id, val, dur) %>%
  mutate(dur = dur/60000) %>%
  group_by(aclew_child_id, val) %>%
  summarize(segment_dur = sum(dur)) %>%
  rename(segment = "val") %>%
  mutate(
    sample = case_when(
      grepl("va", segment) ~ "vocal-activity",
      grepl("tt", segment) ~ "turn-taking"
    ),
    sample_type = case_when(
      grepl("^ext", segment) ~ "extension",
      grepl("^va", segment) ~ "vocal-activity",
      grepl("^tt", segment) ~ "turn-taking"
    )
  )

# XDS
xds.per.seg.nonrand <- all.data %>%
  filter(sample != "random" & speaker != "CHI" &
           grepl("xds@", tier)) %>%
  group_by(aclew_child_id, segment) %>%
  summarise(xds_min = round(sum(dur)/60000,3)) %>%
  full_join(all.nonrand.segments,
    by = c("aclew_child_id", "segment")) %>%
  replace_na(list(xds_min = 0)) %>%
  mutate(xds_mph = (xds_min/segment_dur)*60) %>%
  arrange(aclew_child_id, segment)
# ODS
ods.per.seg.nonrand <- all.data %>%
  filter(sample != "random" & speaker != "CHI" &
           grepl("xds@", tier) & val != "T") %>%
  group_by(aclew_child_id, segment) %>%
  summarise(ods_min = round(sum(dur)/60000,3)) %>%
  full_join(all.nonrand.segments,
    by = c("aclew_child_id", "segment")) %>%
  replace_na(list(ods_min = 0)) %>%
  mutate(ods_mph = (ods_min/segment_dur)*60) %>%
  arrange(aclew_child_id, segment)
# TDS
tds.per.seg.nonrand <- all.data %>%
  filter(sample != "random" & speaker != "CHI" &
           grepl("xds@", tier) & val == "T") %>%
  group_by(aclew_child_id, segment) %>%
  summarise(tds_min = round(sum(dur)/60000,3)) %>%
  full_join(all.nonrand.segments,
    by = c("aclew_child_id", "segment")) %>%
  replace_na(list(tds_min = 0)) %>%
  mutate(tds_mph = (tds_min/segment_dur)*60) %>%
  arrange(aclew_child_id, segment)
# All CDS
cds.per.seg.nonrand <- all.data %>%
  filter(sample != "random" & speaker != "CHI" &
           grepl("xds@", tier) & (val == "T" | val == "C")) %>%
  group_by(aclew_child_id, segment) %>%
  summarise(cds_min = round(sum(dur)/60000,3)) %>%
  full_join(all.nonrand.segments,
    by = c("aclew_child_id", "segment")) %>%
  replace_na(list(cds_min = 0)) %>%
  mutate(cds_mph = (cds_min/segment_dur)*60) %>%
  arrange(aclew_child_id, segment)
# Number of speakers per clip
spkrs.per.seg.nonrand <- all.data %>%
  filter(sample != "random" & speaker != "CHI"
    & !(grepl("@", tier))) %>%
  group_by(aclew_child_id, segment) %>%
  summarise(n_spkrs_clip = length(unique(speaker)))
# All together
seg.distinct <- seg.info %>%
  group_by(aclew_child_id, val) %>%
  summarize(start.hr.min = min(start.hr)) %>%
  rename(start.hr = start.hr.min)
quantity.nonrand <- xds.per.seg.nonrand %>%
  full_join(ods.per.seg.nonrand, by = c("aclew_child_id", "segment",
                                        "segment_dur", "sample", "sample_type")) %>%
  full_join(tds.per.seg.nonrand, by = c("aclew_child_id", "segment",
                                        "segment_dur", "sample", "sample_type")) %>%
  full_join(cds.per.seg.nonrand, by = c("aclew_child_id", "segment",
                                        "segment_dur", "sample", "sample_type")) %>%
  full_join(ptcp.info, by = "aclew_child_id") %>%
  full_join(spkrs.per.seg.nonrand, by = c("aclew_child_id", "segment")) %>%
  left_join(seg.distinct,
            by = c("aclew_child_id" = "aclew_child_id", "segment" = "val")) %>%
  replace_na(list(xds_min = 0, xds_mph = 0,
                  ods_min = 0, ods_mph = 0,
                  tds_min = 0, tds_mph = 0,
                  cds_min = 0, cds_mph = 0,
                  n_spkrs_clip = 0)) %>%
  mutate(prop_tds = tds_min/xds_min)
  # Don't replace NAs with 0s in this case; proportion is not meaningful w/o any speech
quantity.nonrand.bychild <- quantity.nonrand %>%
  group_by(aclew_child_id, sample) %>%
  summarise(
    xds_min = mean(xds_min),
    xds_mph = mean(xds_mph),
    ods_min = mean(ods_min),
    ods_mph = mean(ods_mph),
    tds_min = mean(tds_min),
    tds_mph = mean(tds_mph),
    cds_min = mean(cds_min),
    cds_mph = mean(cds_mph),
    prop_tds = mean(prop_tds, na.rm = TRUE),
    m_n_spkrs = mean(n_spkrs_clip)) %>%
  full_join(ptcp.info, by = "aclew_child_id")

# Get xds and tds min/hr by speaker type
all.nonrand.segments.sa <- tibble(
  aclew_child_id = rep(all.nonrand.segments$aclew_child_id, 2),
  segment = rep(all.nonrand.segments$segment, 2),
  segment_dur = rep(all.nonrand.segments$segment_dur, 2),
  sample = rep(all.nonrand.segments$sample, 2),
  sample_type = rep(all.nonrand.segments$sample_type, 2),
  SpkrAge = c(rep("Adult", nrow(all.nonrand.segments)),
              rep("Child", nrow(all.nonrand.segments))))
# XDS
xds.per.seg.nonrand.sa <- all.data %>%
  filter(sample != "random" & speaker != "CHI" &
      SpkrAge != "Not known" & grepl("xds@", tier)) %>%
  group_by(aclew_child_id, SpkrAge, segment) %>%
  summarise(xds_min.sa = round(sum(dur)/60000,3)) %>%
  full_join(all.nonrand.segments.sa,
    by = c("aclew_child_id", "segment", "SpkrAge")) %>%
  replace_na(list(xds_min.sa = 0)) %>%
  mutate(xds_mph.sa = (xds_min.sa/segment_dur)*60) %>%
  arrange(aclew_child_id, segment, SpkrAge)
# ODS
ods.per.seg.nonrand.sa <- all.data %>%
  filter(sample != "random" & speaker != "CHI" &
      SpkrAge != "Not known" & grepl("xds@", tier) & val != "T") %>%
  group_by(aclew_child_id, SpkrAge, segment) %>%
  summarise(ods_min.sa = round(sum(dur)/60000,3)) %>%
  full_join(all.nonrand.segments.sa,
    by = c("aclew_child_id", "segment", "SpkrAge")) %>%
  replace_na(list(ods_min.sa = 0)) %>%
  mutate(ods_mph.sa = (ods_min.sa/segment_dur)*60) %>%
  arrange(aclew_child_id, segment, SpkrAge)
# TDS
tds.per.seg.nonrand.sa <- all.data %>%
  filter(sample != "random" & speaker != "CHI" &
      SpkrAge != "Not known" & grepl("xds@", tier) & val == "T") %>%
  group_by(aclew_child_id, SpkrAge, segment) %>%
  summarise(tds_min.sa = round(sum(dur)/60000,3)) %>%
  full_join(all.nonrand.segments.sa,
    by = c("aclew_child_id", "segment", "SpkrAge")) %>%
  replace_na(list(tds_min.sa = 0)) %>%
  mutate(tds_mph.sa = (tds_min.sa/segment_dur)*60) %>%
  arrange(aclew_child_id, segment, SpkrAge)
# All CDS
cds.per.seg.nonrand.sa <- all.data %>%
  filter(sample != "random" & speaker != "CHI" &
      SpkrAge != "Not known" & grepl("xds@", tier) &
      (val == "T" | val == "C")) %>%
  group_by(aclew_child_id, SpkrAge, segment) %>%
  summarise(cds_min.sa = round(sum(dur)/60000,3)) %>%
  full_join(all.nonrand.segments.sa,
    by = c("aclew_child_id", "segment", "SpkrAge")) %>%
  replace_na(list(cds_min.sa = 0)) %>%
  mutate(cds_mph.sa = (cds_min.sa/segment_dur)*60) %>%
  arrange(aclew_child_id, segment, SpkrAge)
# Number of speakers per clip
spkrs.per.seg.nonrand.sa <- all.data %>%
  filter(sample != "random" & speaker != "CHI" &
      SpkrAge != "Not known" & !(grepl("@", tier))) %>%
  group_by(aclew_child_id, SpkrAge, segment) %>%
  summarise(n_spkrs_clip = length(unique(speaker)))
# All together
quantity.nonrand.sa <- xds.per.seg.nonrand.sa %>%
  full_join(ods.per.seg.nonrand.sa, by = c("aclew_child_id", "SpkrAge",
                                           "segment", "segment_dur",
                                           "sample", "sample_type")) %>%
  full_join(tds.per.seg.nonrand.sa, by = c("aclew_child_id", "SpkrAge",
                                           "segment", "segment_dur",
                                           "sample", "sample_type")) %>%
  full_join(cds.per.seg.nonrand.sa, by = c("aclew_child_id", "SpkrAge",
                                           "segment", "segment_dur",
                                           "sample", "sample_type")) %>%
  full_join(dplyr::select(quantity.nonrand, c("aclew_child_id", "segment", "tds_min")),
            by = c("aclew_child_id", "segment")) %>%
  full_join(ptcp.info, by = "aclew_child_id") %>%
  full_join(spkrs.per.seg.nonrand.sa, by = c("aclew_child_id", "SpkrAge", "segment")) %>%
  left_join(seg.distinct,
            by = c("aclew_child_id" = "aclew_child_id", "segment" = "val")) %>%
  replace_na(list(xds_min.sa = 0, xds_mph.sa = 0,
                  ods_min.sa = 0, ods_mph.sa = 0,
                  tds_min.sa = 0, tds_mph.sa = 0,
                  cds_min.sa = 0, cds_mph.sa = 0,
                  n_spkrs_clip = 0)) %>%
  mutate(prop_tds.sa = tds_min.sa/xds_min.sa,
         prop_sa.tds = tds_min.sa/tds_min)
  # Don't replace NAs with 0s in this case; proportion is not meaningful w/o any speech

# Subset the non-random samples (used for differnt purposes)
quantity.nonrand.tt <- filter(quantity.nonrand, sample == "turn-taking")
quantity.nonrand.tt.sa <- filter(quantity.nonrand.sa, sample == "turn-taking")
quantity.nonrand.va <- filter(quantity.nonrand, sample == "vocal-activity")
quantity.nonrand.va.sa <- filter(quantity.nonrand.sa, sample == "vocal-activity")


## Get variables ready for modeling
# random sample
quantity.rand$child_sex <- as.factor(quantity.rand$child_sex)
quantity.rand$mat_ed <- as.factor(quantity.rand$mat_ed)
nspkrs.m <- mean(quantity.rand$n_spkrs_clip)
nspkrs.sd <- sd(quantity.rand$n_spkrs_clip)
quantity.rand <- quantity.rand %>%
  mutate(
    xds_mph.nz = ifelse(xds_mph > 0, 1, 0),
    ods_mph.nz = ifelse(ods_mph > 0, 1, 0),
    tds_mph.nz = ifelse(tds_mph > 0, 1, 0),
    cds_mph.nz = ifelse(cds_mph > 0, 1, 0),
    tchiyr.std = ((age_mo_round - tchiyr.m)/tchiyr.sd),
    chisx.std = recode_factor(child_sex,
                              "M" = "M", "F" = "F"),
    mated.std = recode_factor(mat_ed,
                              "none" = "none", "primary" = "primary",
                              "secondary" = "secondary", "preparatory" = "preparatory"),
    mated.bin = recode_factor(mat_ed,
                              "none" = "0-6", "primary" = "0-6",
                              "secondary" = "7+", "preparatory" = "7+"),
    motyr.std = ((mat_age - motyr.m)/motyr.sd),
    nsb.std = ((number_older_sibs - nsb.m)/nsb.sd),
    hsz.std = ((household_size - hsz.m)/hsz.sd),
    nsk.std = ((n_spkrs_clip - nspkrs.m)/nspkrs.sd),
    stthr.std = (start.hr - 12)/12,
    stthr.tri = ifelse(start.hr < 11, "morning",
                       ifelse(start.hr > 13, "afternoon", "midday")))
quantity.rand$stthr.tri <- factor(quantity.rand$stthr.tri,
                                  levels = c("midday", "morning", "afternoon"))
quantity.rand$stthr.tri.a <- factor(quantity.rand$stthr.tri,
                                  levels = c("afternoon", "midday", "morning"))
quantity.rand$stthr.tri.o <- factor(quantity.rand$stthr.tri,
                                  levels = c("morning", "afternoon", "midday"))

quantity.rand.sa$child_sex <- as.factor(quantity.rand.sa$child_sex)
quantity.rand.sa$mat_ed <- as.factor(quantity.rand.sa$mat_ed)
nspkrs.sa.m <- mean(quantity.rand.sa$n_spkrs_clip)
nspkrs.sa.sd <- sd(quantity.rand.sa$n_spkrs_clip)
quantity.rand.sa <- quantity.rand.sa %>%
  mutate(
    xds_mph.sa.nz = ifelse(xds_mph.sa > 0, 1, 0),
    ods_mph.sa.nz = ifelse(ods_mph.sa > 0, 1, 0),
    tds_mph.sa.nz = ifelse(tds_mph.sa > 0, 1, 0),
    cds_mph.sa.nz = ifelse(cds_mph.sa > 0, 1, 0),
    tchiyr.std = ((age_mo_round - tchiyr.m)/tchiyr.sd),
    chisx.std = recode_factor(child_sex,
                              "M" = "M", "F" = "F"),
    mated.std = recode_factor(mat_ed,
                              "none" = "none", "primary" = "primary",
                              "secondary" = "secondary", "preparatory" = "preparatory"),
    mated.bin = recode_factor(mat_ed,
                              "none" = "0-6", "primary" = "0-6",
                              "secondary" = "7+", "preparatory" = "7+"),
    motyr.std = ((mat_age - motyr.m)/motyr.sd),
    nsb.std = ((number_older_sibs - nsb.m)/nsb.sd),
    hsz.std = ((household_size - hsz.m)/hsz.sd),
    nsk.std = ((n_spkrs_clip - nspkrs.sa.m)/nspkrs.sa.sd),
    stthr.std = (start.hr - 12)/12,
    stthr.tri = ifelse(start.hr < 11, "morning",
                       ifelse(start.hr > 13, "afternoon", "midday")))
quantity.rand.sa$stthr.tri <- factor(quantity.rand.sa$stthr.tri,
                                     levels = c("midday", "morning", "afternoon"))
quantity.rand.sa$stthr.tri.a <- factor(quantity.rand.sa$stthr.tri,
                                       levels = c("afternoon", "midday", "morning"))
quantity.rand.sa$stthr.tri.o <- factor(quantity.rand.sa$stthr.tri,
                                       levels = c("morning", "afternoon", "midday"))


# tt sample
quantity.nonrand.tt$child_sex <- as.factor(quantity.nonrand.tt$child_sex)
quantity.nonrand.tt$mat_ed <- as.factor(quantity.nonrand.tt$mat_ed)
nspkrs.m <- mean(quantity.nonrand.tt$n_spkrs_clip)
nspkrs.sd <- sd(quantity.nonrand.tt$n_spkrs_clip)
quantity.nonrand.tt <- quantity.nonrand.tt %>%
  mutate(
    xds_mph.nz = ifelse(xds_mph > 0, 1, 0),
    ods_mph.nz = ifelse(ods_mph > 0, 1, 0),
    tds_mph.nz = ifelse(tds_mph > 0, 1, 0),
    cds_mph.nz = ifelse(cds_mph > 0, 1, 0),
    tchiyr.std = ((age_mo_round - tchiyr.m)/tchiyr.sd),
    chisx.std = recode_factor(child_sex,
                              "M" = "M", "F" = "F"),
    mated.std = recode_factor(mat_ed,
                              "none" = "none", "primary" = "primary",
                              "secondary" = "secondary", "preparatory" = "preparatory"),
    mated.bin = recode_factor(mat_ed,
                              "none" = "0-6", "primary" = "0-6",
                              "secondary" = "7+", "preparatory" = "7+"),
    motyr.std = ((mat_age - motyr.m)/motyr.sd),
    nsb.std = ((number_older_sibs - nsb.m)/nsb.sd),
    hsz.std = ((household_size - hsz.m)/hsz.sd),
    nsk.std = ((n_spkrs_clip - nspkrs.m)/nspkrs.sd),
    stthr.std = (start.hr - 12)/12,
    stthr.tri = ifelse(start.hr < 11, "morning",
                       ifelse(start.hr > 13, "afternoon", "midday")))
quantity.nonrand.tt$stthr.tri <- factor(quantity.nonrand.tt$stthr.tri,
                                        levels = c("midday", "morning", "afternoon"))
quantity.nonrand.tt$stthr.tri.a <- factor(quantity.nonrand.tt$stthr.tri,
                                          levels = c("afternoon", "midday", "morning"))
quantity.nonrand.tt$stthr.tri.o <- factor(quantity.nonrand.tt$stthr.tri,
                                          levels = c("morning", "afternoon", "midday"))

quantity.nonrand.tt.sa$child_sex <- as.factor(quantity.nonrand.tt.sa$child_sex)
quantity.nonrand.tt.sa$mat_ed <- as.factor(quantity.nonrand.tt.sa$mat_ed)
nspkrs.sa.m <- mean(quantity.nonrand.tt.sa$n_spkrs_clip)
nspkrs.sa.sd <- sd(quantity.nonrand.tt.sa$n_spkrs_clip)
quantity.nonrand.tt.sa <- quantity.nonrand.tt.sa %>%
  mutate(
    xds_mph.sa.nz = ifelse(xds_mph.sa > 0, 1, 0),
    ods_mph.sa.nz = ifelse(ods_mph.sa > 0, 1, 0),
    tds_mph.sa.nz = ifelse(tds_mph.sa > 0, 1, 0),
    cds_mph.sa.nz = ifelse(cds_mph.sa > 0, 1, 0),
    tchiyr.std = ((age_mo_round - tchiyr.m)/tchiyr.sd),
    chisx.std = recode_factor(child_sex,
                              "M" = "M", "F" = "F"),
    mated.std = recode_factor(mat_ed,
                              "none" = "none", "primary" = "primary",
                              "secondary" = "secondary", "preparatory" = "preparatory"),
    mated.bin = recode_factor(mat_ed,
                              "none" = "0-6", "primary" = "0-6",
                              "secondary" = "7+", "preparatory" = "7+"),
    motyr.std = ((mat_age - motyr.m)/motyr.sd),
    nsb.std = ((number_older_sibs - nsb.m)/nsb.sd),
    hsz.std = ((household_size - hsz.m)/hsz.sd),
    nsk.std = ((n_spkrs_clip - nspkrs.sa.m)/nspkrs.sa.sd),
    stthr.std = (start.hr - 12)/12,
    stthr.tri = ifelse(start.hr < 11, "morning",
                       ifelse(start.hr > 13, "afternoon", "midday")))
quantity.nonrand.tt.sa$stthr.tri <- factor(quantity.nonrand.tt.sa$stthr.tri,
                                           levels = c("midday", "morning", "afternoon"))
quantity.nonrand.tt.sa$stthr.tri.a <- factor(quantity.nonrand.tt.sa$stthr.tri,
                                             levels = c("afternoon", "midday", "morning"))
quantity.nonrand.tt.sa$stthr.tri.o <- factor(quantity.nonrand.tt.sa$stthr.tri,
                                             levels = c("morning", "afternoon", "midday"))

```

```{r quantity_plots, message=FALSE, warning=FALSE, paged.print=FALSE}
quantity.nonrand.tt.minimum <- dplyr::select(quantity.nonrand.tt,
                                             age_mo_round, xds_mph, ods_mph, tds_mph,
                                             prop_tds, n_spkrs_clip) %>%
                                             mutate(Sample = "Turn taking")
quantity.rand.minimum <- dplyr::select(quantity.rand,
                                       age_mo_round, xds_mph, ods_mph, tds_mph,
                                       prop_tds, n_spkrs_clip) %>%
                                       mutate(Sample = "Random")
quantity.rand_and_tt <- bind_rows(quantity.nonrand.tt.minimum, quantity.rand.minimum)

quantity.nonrand.sa.tt.minimum <- dplyr::select(quantity.nonrand.tt.sa,
                                             age_mo_round, prop_sa.tds, SpkrAge) %>%
                                             mutate(Sample = "Turn taking")
quantity.rand.sa.minimum <- dplyr::select(quantity.rand.sa,
                                       age_mo_round, prop_sa.tds, SpkrAge) %>%
                                       mutate(Sample = "Random")
quantity.sa.rand_and_tt <- bind_rows(
  quantity.nonrand.sa.tt.minimum, quantity.rand.sa.minimum)

write_csv(quantity.rand_and_tt,
          paste0(shiny.input.path,
                 "quantity-scores_rand-and-tt.csv"))

# ODS min/hr
odsmph.segments.rand_and_tt <- ggplot(quantity.rand_and_tt,
                          aes(x = age_mo_round, y = ods_mph, lty = Sample)) +
  geom_boxplot(aes(group = interaction(age_mo_round, Sample),
                   color = Sample), fill = "white", outlier.shape = NA,
               lty = "solid", alpha = 0.4) +
  geom_smooth(aes(fill = Sample, color = Sample), method = "lm") +
  ylab("ODS (min/hr)") + xlab("Child age (mo)")	+
  scale_y_continuous(limits=c(-10,80),
                     breaks=seq(0,80,20)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,80),xlim=c(0,38)) +
  scale_color_manual(values = viridis(3)) +
  scale_fill_manual(values = viridis(3)) +
  theme_apa() +
  theme(legend.position="none",
        axis.line = element_line(color="black", size = 0.4))

# TDS min/hr
tdsmph.segments.rand_and_tt <- ggplot(quantity.rand_and_tt,
                          aes(x = age_mo_round, y = tds_mph, lty = Sample)) +
  geom_boxplot(aes(group = interaction(age_mo_round, Sample),
                   color = Sample), fill = "white", outlier.shape = NA,
               lty = "solid", alpha = 0.4) +
  geom_smooth(aes(fill = Sample, color = Sample), method = "lm") +
  ylab("TCDS (min/hr)") + xlab("Child age (mo)")	+
  scale_y_continuous(limits=c(0,80),
                     breaks=seq(0,80,20)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,80),xlim=c(0,38)) +
  scale_color_manual(values = viridis(3)) +
  scale_fill_manual(values = viridis(3)) +
  theme_apa() +
  theme(legend.position="none",
        axis.line = element_line(color="black", size = 0.4))

# TDS min/hr - zoomed in
tdsmph.segments.rand_and_tt.zoomedin <- ggplot(quantity.rand_and_tt,
                          aes(x = age_mo_round, y = tds_mph, lty = Sample)) +
  geom_boxplot(aes(group = interaction(age_mo_round, Sample),
                   color = Sample), fill = "white", outlier.shape = NA,
               lty = "solid", alpha = 0.4) +
  geom_smooth(aes(fill = Sample, color = Sample), method = "lm") +
  ylab("TCDS (min/hr)") + xlab("Child age (mo)")	+
  scale_y_continuous(limits=c(0,40),
                     breaks=seq(0,40,10)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,40),xlim=c(0,38)) +
  scale_color_manual(values = viridis(3)) +
  scale_fill_manual(values = viridis(3)) +
  theme_apa() +
  theme(legend.position="none",
        axis.line = element_line(color="black", size = 0.4))

# TDS prop
tdsprp.segments.rand_and_tt <- ggplot(quantity.rand_and_tt,
                          aes(x = age_mo_round, y = prop_tds, lty = Sample)) +
  geom_boxplot(aes(group = interaction(age_mo_round, Sample),
                   color = Sample), fill = "white", outlier.shape = NA,
               lty = "solid", alpha = 0.4) +
  geom_smooth(aes(fill = Sample, color = Sample), method = "lm") +
  ylab("TCDS/All spch") + xlab("Child age (mo)")	+
  scale_y_continuous(limits=c(-.2,1.2),
                     breaks=seq(0,1,0.2)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,1),xlim=c(0,38)) +
  scale_color_manual(values = viridis(3)) +
  scale_fill_manual(values = viridis(3)) +
  theme_apa() +
  theme(legend.position="none",
        axis.line = element_line(color="black", size = 0.4))

# prop TDS from children
tdsprp.segments.rand_and_tt.sa <- ggplot(subset(quantity.sa.rand_and_tt,
                                                SpkrAge == "Child"),
                             aes(x = age_mo_round, y = prop_sa.tds, lty = Sample)) +
  geom_boxplot(aes(group = interaction(age_mo_round, Sample),
                   color = Sample), fill = "white", outlier.shape = NA,
               lty = "solid", alpha = 0.4) +
  geom_smooth(aes(fill = Sample, color = Sample), method = "lm") +
  ylab("Prop of TCDS") + xlab("Child age (mo)")	+
  scale_y_continuous(limits=c(-.2,1.2),
                     breaks=seq(0,1,0.2)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,1), xlim=c(0,38)) +
  scale_color_manual(values = viridis(3)) +
  scale_fill_manual(values = viridis(3)) +
  theme_apa() +
  theme(legend.position="none",
        axis.line = element_line(color="black", size = 0.4))

## TOD plots
quantity.nonrand.tt$Sample <- "Turn taking"
quantity.rand$Sample <- "Random"
quantity.rand_and_tt.all <- bind_rows(quantity.nonrand.tt, quantity.rand)
quantity.rand_and_tt.all$stthr.tri.centered <- factor(
  quantity.rand_and_tt.all$stthr.tri,
  levels = c("morning", "midday", "afternoon"))
quantity.rand_and_tt.all$SplitAge <- ifelse(
  quantity.rand_and_tt.all$age_mo_round < 13, "Under 1;0", "1;0+")
quantity.rand_and_tt.all$SplitAge <- factor(quantity.rand_and_tt.all$SplitAge,
  levels = c("Under 1;0", "1;0+"))

write_csv(quantity.rand_and_tt.all,
          paste0(shiny.input.path,
                 "quantity-scores_rand-and-tt-TOD.csv"))

tod.tcds <- ggplot(data = quantity.rand_and_tt.all, aes(
  y = round(tds_mph, 0), x = stthr.tri.centered,
  group = interaction(SplitAge, stthr.tri.centered),
  color = Sample,
  fill = Sample,
  alpha = SplitAge)) +
  geom_jitter() +
  geom_boxplot(color = "black") +
  facet_grid(~ Sample) +
  ylab("TCDS (min/hr)") + xlab("Time of day")	+
  labs(alpha = "Age") +
  scale_y_continuous(limits=c(-10,40),
                     breaks=c(0,10,20, 30, 40)) +
  scale_color_manual(guide = FALSE, values = viridis(3)) +
  scale_fill_manual(guide = FALSE, values = viridis(3)) +
  scale_alpha_discrete(range = c(0.2, 0.8)) +
  coord_cartesian(ylim=c(0,40)) +
  theme_apa() +
  theme(legend.position="right",
        axis.line = element_line(color="black", size = 0.4)) +
  guides(alpha = guide_legend(override.aes = list(
    fill = c("gray80", "gray30"))))

tod.ods <- ggplot(data = quantity.rand_and_tt.all, aes(
  y = round(ods_mph, 0), x = stthr.tri.centered,
  group = interaction(SplitAge, stthr.tri.centered),
  color = Sample,
  fill = Sample,
  alpha = SplitAge)) +
  geom_jitter() +
  geom_boxplot(color = "black") +
  facet_grid(~ Sample) +
  ylab("ODS (min/hr)") + xlab("Time of day")	+
  labs(alpha = "Age") +
  scale_y_continuous(limits=c(-10,80),
                     breaks=seq(0,80,20)) +
  scale_color_manual(guide = FALSE, values = viridis(3)) +
  scale_fill_manual(guide = FALSE, values = viridis(3)) +
  scale_alpha_discrete(range = c(0.2, 0.8)) +
  coord_cartesian(ylim=c(0,80)) +
  theme_apa() +
  theme(legend.position="right",
        axis.line = element_line(color="black", size = 0.4)) +
  guides(alpha = guide_legend(override.aes = list(
    fill = c("gray80", "gray30"))))

# individual TOD plots
tod.tcds.rand <- ggplot(
  data = subset(quantity.rand_and_tt.all, Sample == "Random"), aes(
  y = round(tds_mph, 0), x = stthr.tri.centered,
  group = interaction(SplitAge, stthr.tri.centered),
  color = Sample,
  fill = Sample,
  alpha = SplitAge)) +
  geom_jitter() +
  geom_boxplot(color = "black") +
  ylab("TCDS (min/hr)") + xlab("")	+
  ggtitle("Random") +
  labs(alpha = "Age") +
  scale_y_continuous(limits=c(-10,40),
                     breaks=c(0,10,20, 30, 40)) +
  scale_color_manual(guide = FALSE, values = viridis(3)) +
  scale_fill_manual(guide = FALSE, values = viridis(3)) +
  scale_alpha_discrete(range = c(0.2, 0.8)) +
  coord_cartesian(ylim=c(0,40)) +
  theme_apa() +
  theme(legend.position="none",
        axis.line = element_line(color="black", size = 0.4),
        plot.title = element_text(hjust = 0.5))

tod.ods.rand <- ggplot(
  data = subset(quantity.rand_and_tt.all, Sample == "Random"), aes(
  y = round(ods_mph, 0), x = stthr.tri.centered,
  group = interaction(SplitAge, stthr.tri.centered),
  color = Sample,
  fill = Sample,
  alpha = SplitAge)) +
  geom_jitter() +
  geom_boxplot(color = "black") +
  ylab("ODS (min/hr)") + xlab("")	+
  ggtitle("Random") +
  labs(alpha = "Age") +
  scale_y_continuous(limits=c(-10,80),
                     breaks=seq(0,80,20)) +
  scale_color_manual(guide = FALSE, values = viridis(3)) +
  scale_fill_manual(guide = FALSE, values = viridis(3)) +
  scale_alpha_discrete(range = c(0.2, 0.8)) +
  coord_cartesian(ylim=c(0,80)) +
  theme_apa() +
  theme(legend.position="none",
        axis.line = element_line(color="black", size = 0.4),
        plot.title = element_text(hjust = 0.5))

tod.tcds.tt <- ggplot(
  data = subset(quantity.rand_and_tt.all, Sample == "Turn taking"), aes(
  y = round(tds_mph, 0), x = stthr.tri.centered,
  group = interaction(SplitAge, stthr.tri.centered),
  color = Sample,
  fill = Sample,
  alpha = SplitAge)) +
  geom_jitter() +
  geom_boxplot(color = "black") +
  ylab("TCDS (min/hr)") + xlab("Time of day")	+
  ggtitle("Turn taking") +
  labs(alpha = "Age") +
  scale_y_continuous(limits=c(-10,40),
                     breaks=c(0,10,20, 30, 40)) +
  scale_color_manual(guide = FALSE,
                     values = c("#21908CFF", "#21908CFF", "#FDE725FF")) +
  scale_fill_manual(guide = FALSE,
                    values = c("#21908CFF", "#21908CFF", "#FDE725FF")) +
  scale_alpha_discrete(range = c(0.2, 0.8)) +
  coord_cartesian(ylim=c(0,40)) +
  theme_apa() +
  theme(legend.position="none",
        axis.line = element_line(color="black", size = 0.4),
        plot.title = element_text(hjust = 0.5))

tod.ods.tt <- ggplot(
  data = subset(quantity.rand_and_tt.all, Sample == "Turn taking"), aes(
  y = round(ods_mph, 0), x = stthr.tri.centered,
  group = interaction(SplitAge, stthr.tri.centered),
  color = Sample,
  fill = Sample,
  alpha = SplitAge)) +
  geom_jitter() +
  geom_boxplot(color = "black") +
  ylab("ODS (min/hr)") + xlab("Time of day")	+
  ggtitle("Turn taking") +
  labs(alpha = "Age") +
  scale_y_continuous(limits=c(-10,80),
                     breaks=seq(0,80,20)) +
  scale_color_manual(guide = FALSE,
                     values = c("#21908CFF", "#21908CFF", "#FDE725FF")) +
  scale_fill_manual(guide = FALSE,
                    values = c("#21908CFF", "#21908CFF", "#FDE725FF")) +
  scale_alpha_discrete(range = c(0.2, 0.8)) +
  coord_cartesian(ylim=c(0,80)) +
  theme_apa() +
  theme(legend.position="none",
        axis.line = element_line(color="black", size = 0.4),
        plot.title = element_text(hjust = 0.5))


### alternate for presentation
# TDS min/hr - zoomed in
tdsmph.segments.rand_and_tt.zoomedin.1 <- ggplot(quantity.rand,
                          aes(x = age_mo_round, y = tds_mph)) +
  geom_boxplot(aes(group = age_mo_round), fill = "gray50", color = "black",
               outlier.shape = NA,
               lty = "solid") +
  geom_smooth(fill = "black", color = "black", method = "lm") +
  ylab("TCDS (min/hr)") + xlab("Child age (mo)")	+
  scale_y_continuous(limits=c(0,40),
                     breaks=seq(0,40,10)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,40),xlim=c(0,38)) +
  theme_apa() +
  basic.theme + theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
		axis.text.x = element_text(color="black"),
	  axis.title.x = element_text(color="black"),
	  axis.text.y = element_text(color="black"),
	  axis.title.y = element_text(color="black"),
	  strip.text = element_text(color="black"),
		axis.ticks = element_line(color = "black"),
		axis.line = element_line(color="black", size = 0.4),
		legend.position = "none")

tdsmph.segments.rand_and_tt.zoomedin.2 <- ggplot(quantity.nonrand.tt,
                          aes(x = age_mo_round, y = tds_mph)) +
  geom_boxplot(aes(group = age_mo_round), fill = "pink", color = "red",
               outlier.shape = NA,
               lty = "solid", alpha = 0.4) +
  geom_smooth(fill = "red", color = "red", method = "lm") +
  ylab("TCDS (min/hr)") + xlab("Child age (mo)")	+
  scale_y_continuous(limits=c(0,40),
                     breaks=seq(0,40,10)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,40),xlim=c(0,38)) +
  theme_apa() +
  basic.theme + theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
		axis.text.x = element_text(color="black"),
	  axis.title.x = element_text(color="black"),
	  axis.text.y = element_text(color="black"),
	  axis.title.y = element_text(color="black"),
	  strip.text = element_text(color="black"),
		axis.ticks = element_line(color = "black"),
		axis.line = element_line(color="black", size = 0.4),
		legend.position = "none")

png(paste("diff_figs/","tcds.1.png", sep=""),
    width=500, height=400,units="px", bg = "transparent")
print(tdsmph.segments.rand_and_tt.zoomedin.1)
dev.off()
png(paste("diff_figs/","tcds.2.png", sep=""),
    width=500, height=400,units="px", bg = "transparent")
print(tdsmph.segments.rand_and_tt.zoomedin.2)
dev.off()

odsmph.segments.rand_and_tt.1 <- ggplot(quantity.rand,
                          aes(x = age_mo_round, y = ods_mph)) +
  geom_boxplot(aes(group = age_mo_round), fill = "gray50", color = "black",
               outlier.shape = NA,
               lty = "solid") +
  geom_smooth(fill = "black", color = "black", method = "lm") +
  ylab("ODS (min/hr)") + xlab("Child age (mo)")	+
  scale_y_continuous(limits=c(-10,80),
                     breaks=seq(0,80,20)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,80),xlim=c(0,38)) +
  theme_apa() +
  basic.theme + theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
		axis.text.x = element_text(color="black"),
	  axis.title.x = element_text(color="black"),
	  axis.text.y = element_text(color="black"),
	  axis.title.y = element_text(color="black"),
	  strip.text = element_text(color="black"),
		axis.ticks = element_line(color = "black"),
		axis.line = element_line(color="black", size = 0.4),
		legend.position = "none")

odsmph.segments.rand_and_tt.2 <- ggplot(quantity.nonrand.tt,
                          aes(x = age_mo_round, y = ods_mph)) +
  geom_boxplot(aes(group = age_mo_round), fill = "pink", color = "red",
               outlier.shape = NA,
               lty = "solid") +
  geom_smooth(fill = "red", color = "red", method = "lm") +
  ylab("ODS (min/hr)") + xlab("Child age (mo)")	+
  scale_y_continuous(limits=c(-10,80),
                     breaks=seq(0,80,20)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,80),xlim=c(0,38)) +
  theme_apa() +
  basic.theme + theme(
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank(),
		axis.text.x = element_text(color="black"),
	  axis.title.x = element_text(color="black"),
	  axis.text.y = element_text(color="black"),
	  axis.title.y = element_text(color="black"),
	  strip.text = element_text(color="black"),
		axis.ticks = element_line(color = "black"),
		axis.line = element_line(color="black", size = 0.4),
		legend.position = "none")

png(paste("diff_figs/","ods.1.png", sep=""),
    width=500, height=400,units="px", bg = "transparent")
print(odsmph.segments.rand_and_tt.1)
dev.off()
png(paste("diff_figs/","ods.2.png", sep=""),
    width=500, height=400,units="px", bg = "transparent")
print(odsmph.segments.rand_and_tt.2)
dev.off()


```

```{r fig3, echo=FALSE, fig.cap="Estimates of TCDS min/hr (left) and ODS min/hr (right) across the sampled age range. Each box plot summarizes the data for one child from the randomly sampled clips (purple; solid) or the turn taking clips (green; dashed). Bands on the linear trends show 95% confidence intervals.", message=FALSE, warning=FALSE, fig.height=2.5}
grid.arrange(tdsmph.segments.rand_and_tt.zoomedin,
             odsmph.segments.rand_and_tt, nrow=1, ncol=2)
```

``` {r fig5, echo=FALSE, fig.cap="Estimates of TCDS min/hr (left panels) and ODS min/hr (right panels) across the recorded day in the random clips (top panels) and turn-taking (bottom panels) clips. Each box plot summarizes the data for children age 1;0 and younger (light) or age 1;0 and older (dark) at the given time of day.", message=FALSE, warning=FALSE, fig.height=4}
grid.arrange(tod.tcds.rand, tod.ods.rand,
             tod.tcds.tt, tod.ods.tt, nrow=2, ncol=2)
```

```{r tcds_models, message=FALSE, warning=FALSE, paged.print=FALSE}
## TCDS random sample ####
tcds.random.distribution <- ggplot(quantity.rand,
                            aes(round(tds_mph,0))) +
  geom_histogram(binwidth = 2) +
  ylab("# of clips") +
  xlab ("TCDS min/hr") +
  basic.theme
ggsave(paste0(shiny.input.img.path, "TCDS_random_distribution.png"),
       plot = tcds.random.distribution,
       width = 8, height = 6, dpi = 300)
#sd(round(quantity.rand$tds_mph,0))^2
#mean(round(quantity.rand$tds_mph,0))
# mean is much smaller than variance
tds.rand.zinb <- glmmTMB(round(tds_mph,0) ~
                           tchiyr.std +
                           stthr.tri +
                           hsz.std +
                           nsk.std +
                           tchiyr.std:stthr.tri +
                           tchiyr.std:nsk.std +
                           (1|aclew_child_id),
                         data=quantity.rand,
                         ziformula=~nsk.std,
                         family="nbinom1")
#tds.rand.zinb.res = simulateResiduals(tds.rand.zinb)
#plot(tds.rand.zinb.res, rank = T) # (manually saved)
#summary(tds.rand.zinb)
# Data: quantity.rand
# 
#      AIC      BIC   logLik deviance df.resid 
#    416.5    449.0   -195.3    390.5       77 
# 
# Random effects:
# 
# Conditional model:
#  Groups         Name        Variance       Std.Dev.  
#  aclew_child_id (Intercept) 0.000000000797 0.00002823
# Number of obs: 90, groups:  aclew_child_id, 10
# 
# Overdispersion parameter for nbinom1 family (): 3.37 
# 
# Conditional model:
#                               Estimate Std. Error z value Pr(>|z|)   
# (Intercept)                    0.69020    0.31898   2.164  0.03048 * 
# tchiyr.std                     0.73104    0.22844   3.200  0.00137 **
# stthr.trimorning               0.80009    0.35930   2.227  0.02596 * 
# stthr.triafternoon             0.25885    0.35412   0.731  0.46480   
# hsz.std                       -0.20738    0.12268  -1.690  0.09096 . 
# nsk.std                       -0.04380    0.16428  -0.267  0.78976   
# tchiyr.std:stthr.trimorning   -0.58894    0.30302  -1.944  0.05194 . 
# tchiyr.std:stthr.triafternoon -0.59649    0.29170  -2.045  0.04087 * 
# tchiyr.std:nsk.std            -0.02804    0.10818  -0.259  0.79546   
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Zero-inflation model:
#             Estimate Std. Error z value Pr(>|z|)
# (Intercept)   -9.281     11.509  -0.806    0.420
# nsk.std       -5.655      7.444  -0.760    0.447
# save for reporting
tds.rand.zinb.disp <- round(sigma(tds.rand.zinb), 2)
tds.rand.zinb.COEF.age <-
  coef(summary(tds.rand.zinb))[[1]]["tchiyr.std",] 
tds.rand.zinb.COEF.midd.morn <-
  coef(summary(tds.rand.zinb))[[1]]["stthr.trimorning",] 
tds.rand.zinb.COEF.midd.aft <-
  coef(summary(tds.rand.zinb))[[1]]["stthr.triafternoon",] 
tds.rand.zinb.COEF.age.midd.morn <-
  coef(summary(tds.rand.zinb))[[1]]["tchiyr.std:stthr.trimorning",]
tds.rand.zinb.COEF.age.midd.aft <-
  coef(summary(tds.rand.zinb))[[1]]["tchiyr.std:stthr.triafternoon",]
tds.rand.zinb.COEF.agensk <-
  coef(summary(tds.rand.zinb))[[1]]["tchiyr.std:nsk.std",]

# test the other two-way effects of time of day
tds.rand.zinb.v2 <- glmmTMB(round(tds_mph,0) ~
                           tchiyr.std +
                           stthr.tri.a +
                           hsz.std +
                           nsk.std +
                           tchiyr.std:stthr.tri.a +
                           tchiyr.std:nsk.std +
                           (1|aclew_child_id),
                         data=quantity.rand,
                         ziformula=~nsk.std,
                         family="nbinom1")
#summary(tds.rand.zinb.v2)
# stthr.tri.amorning             0.541238   0.257256   2.104      0.0354 *  
# tchiyr.std:stthr.tri.amorning  0.007545   0.270156   0.028      0.9777  
# save for reporting
tds.rand.zinb.v2.COEF.aft.morn <-
  coef(summary(tds.rand.zinb.v2))[[1]]["stthr.tri.amorning",] 
tds.rand.zinb.v2.COEF.age.aft.morn <-
  coef(summary(tds.rand.zinb.v2))[[1]]["tchiyr.std:stthr.tri.amorning",] 

## TCDS tt sample ####
tcds.tt.distribution <- ggplot(quantity.nonrand.tt,
                            aes(round(tds_mph,0))) +
  geom_histogram(binwidth = 2) +
  ylab("# of clips") +
  xlab ("TCDS min/hr") +
  basic.theme
ggsave(paste0(shiny.input.img.path, "TCDS_turntaking_distribution.png"),
       plot = tcds.tt.distribution,
       width = 8, height = 6, dpi = 300)
#sd(round(quantity.nonrand.tt$tds_mph,0))^2
#mean(round(quantity.nonrand.tt$tds_mph,0))
# mean is much smaller than variance but reasonably normal
# not zero-inflated (nature of this sample)
tds.tt.nb <- glmmTMB(round(tds_mph,0) ~
                       tchiyr.std +
                       stthr.tri +
                       hsz.std +
                       nsk.std +
                       tchiyr.std:stthr.tri +
                       tchiyr.std:nsk.std +
                       (1|aclew_child_id),
                     data=quantity.nonrand.tt,
                     family="nbinom1")
#tds.tt.nb.res = simulateResiduals(tds.tt.nb)
#plot(tds.tt.nb.res, rank = T) # (manually saved)
#summary(tds.tt.nb)
# Data: quantity.nonrand.tt
# 
#      AIC      BIC   logLik deviance df.resid 
#    388.5    410.6   -183.3    366.5       44 
# 
# Random effects:
# 
# Conditional model:
#  Groups         Name        Variance       Std.Dev.  
#  aclew_child_id (Intercept) 0.000000002313 0.00004809
# Number of obs: 55, groups:  aclew_child_id, 10
# 
# Overdispersion parameter for nbinom1 family (): 2.91 
# 
# Conditional model:
#                               Estimate Std. Error z value  Pr(>|z|)    
# (Intercept)                    2.38897    0.25269   9.454  <0.00002 ***
# tchiyr.std                    -0.62835    0.27007  -2.327  0.0200 *  
# stthr.trimorning               0.21896    0.28390   0.771  0.4406    
# stthr.triafternoon             0.33756    0.27312   1.236  0.2165    
# hsz.std                       -0.02033    0.07661  -0.265  0.7907    
# nsk.std                       -0.04457    0.08565  -0.520  0.6028    
# tchiyr.std:stthr.trimorning    0.53280    0.28184   1.890  0.0587 .  
# tchiyr.std:stthr.triafternoon  0.60509    0.27867   2.171  0.0299 *  
# tchiyr.std:nsk.std            -0.15095    0.11158  -1.353  0.1761    
# save for reporting
tds.tt.nb.disp <- round(sigma(tds.tt.nb), 2)
tds.tt.nb.COEF.age <-
  coef(summary(tds.tt.nb))[[1]]["tchiyr.std",] 
tds.tt.nb.COEF.midd.morn <-
  coef(summary(tds.tt.nb))[[1]]["stthr.trimorning",] 
tds.tt.nb.COEF.midd.aft <-
  coef(summary(tds.tt.nb))[[1]]["stthr.triafternoon",] 
tds.tt.nb.COEF.age.midd.morn <-
  coef(summary(tds.tt.nb))[[1]]["tchiyr.std:stthr.trimorning",]
tds.tt.nb.COEF.age.midd.aft <-
  coef(summary(tds.tt.nb))[[1]]["tchiyr.std:stthr.triafternoon",]
tds.tt.nb.COEF.agensk <-
  coef(summary(tds.tt.nb))[[1]]["tchiyr.std:nsk.std",]

# test the other two-way effects of time of day
tds.tt.nb.v2 <- glmmTMB(round(tds_mph,0) ~
                       tchiyr.std +
                       stthr.tri.a +
                       hsz.std +
                       nsk.std +
                       tchiyr.std:stthr.tri.a +
                       tchiyr.std:nsk.std +
                       (1|aclew_child_id),
                     data=quantity.nonrand.tt,
                     family="nbinom1")
#summary(tds.tt.nb.v2)
# stthr.tri.amorning            -0.11860    0.17254  -0.687  0.4919    
# tchiyr.std:stthr.tri.amorning -0.07229    0.17299  -0.418  0.6760    
# no results to save for reporting
```




``` {r chitcdscorrs, message=FALSE, warning=FALSE, paged.print=FALSE}
# Aggregate to one point per child and then test a correlation with age
# random
propchitcds.rand <- subset(quantity.rand.sa[
  which(!is.na(quantity.rand.sa$prop_sa.tds)),],
  SpkrAge == "Child")
propchitcds.rand.corr_age <- propchitcds.rand %>%
  group_by(aclew_child_id, tchiyr.std, age_mo_round) %>%
  summarise(avg_prpchitcds = mean(prop_sa.tds))
propchitcds.rand.corr_age.test <- cor.test(
  ~ age_mo_round + avg_prpchitcds,
  data = propchitcds.rand.corr_age, method = "spearman")
# turn taking
propchitcds.tt <- subset(quantity.nonrand.tt.sa[
  which(!is.na(quantity.nonrand.tt.sa$prop_sa.tds)),],
  SpkrAge == "Child")
propchitcds.tt.corr_age <- propchitcds.tt %>%
  group_by(aclew_child_id, tchiyr.std, age_mo_round) %>%
  summarise(avg_prpchitcds = mean(prop_sa.tds))
propchitcds.tt.corr_age.test <- cor.test(
  ~ age_mo_round + avg_prpchitcds,
  data = propchitcds.tt.corr_age, method = "spearman")

tds.per.seg.rand.age.sx <- all.data %>%
  filter(sample == "random" & speaker != "CHI" & SpkrAge != "Not known" &
           grepl("xds@", tier) & val == "T") %>%
  group_by(aclew_child_id, SpkrAge, SpkrSex, segment, segment_dur) %>%
  summarise(tds_min.age.sx = round(sum(dur)/60000,3)) %>%
  full_join(all.rand.segments.age.sx, by = c("aclew_child_id", "segment", "SpkrAge", "SpkrSex")) %>%
  replace_na(list(segment_dur = 5, tds_min.age.sx = 0)) %>%
  mutate(tds_mph.age.sx = (tds_min.age.sx/segment_dur)*60) %>%
  arrange(aclew_child_id, segment, SpkrAge, SpkrSex) %>%
  group_by(aclew_child_id, SpkrAge, SpkrSex) %>%
  summarize(m_tds_mph.age.sx = mean(tds_mph.age.sx))
tds.per.seg.rand.age.sx.FA <- filter(tds.per.seg.rand.age.sx,
                                     SpkrAge == "Adult" & SpkrSex == "Female") %>%
  rename(m_tds_mph.age.sx.FA = m_tds_mph.age.sx)
tds.per.seg.rand.age.sx.MA <- filter(tds.per.seg.rand.age.sx,
                                     SpkrAge == "Adult" & SpkrSex == "Male") %>%
  rename(m_tds_mph.age.sx.MA = m_tds_mph.age.sx)
adu.sx.ratio <- full_join(tds.per.seg.rand.age.sx.FA, tds.per.seg.rand.age.sx.MA,
                          by = "aclew_child_id") %>%
  mutate(ratioFAMA = m_tds_mph.age.sx.FA/m_tds_mph.age.sx.MA) %>%
  dplyr::select(aclew_child_id, ratioFAMA)

```

``` {r descriptive_stats, message=FALSE, warning=FALSE, paged.print=FALSE}
#TCDS
## random
round(mean(quantity.rand.bychild$tds_mph),2)
round(median(quantity.rand.bychild$tds_mph),2)
round(min(quantity.rand.bychild$tds_mph),2)
round(max(quantity.rand.bychild$tds_mph),2)
## tt
round(mean(subset(quantity.nonrand.bychild, sample == "turn-taking")$tds_mph),2)
round(median(subset(quantity.nonrand.bychild, sample == "turn-taking")$tds_mph),2)
round(min(subset(quantity.nonrand.bychild, sample == "turn-taking")$tds_mph),2)
round(max(subset(quantity.nonrand.bychild, sample == "turn-taking")$tds_mph),2)

# proportion TCDS from adults
round(mean(1-propchitcds.rand.corr_age$avg_prpchitcds),4)*100
round(median(1-propchitcds.rand.corr_age$avg_prpchitcds),4)*100
round(min(1-propchitcds.rand.corr_age$avg_prpchitcds),4)*100
round(max(1-propchitcds.rand.corr_age$avg_prpchitcds),4)*100
chitcds.age.rho <- round(propchitcds.rand.corr_age.test$estimate[[1]],2)
chitcds.age.p <- round(propchitcds.rand.corr_age.test$p.value[[1]],2)

# ODS
## random
round(mean(quantity.rand.bychild$ods_mph),2)
round(median(quantity.rand.bychild$ods_mph),2)
round(min(quantity.rand.bychild$ods_mph),2)
round(max(quantity.rand.bychild$ods_mph),2)
## tt
round(mean(subset(quantity.nonrand.bychild, sample == "turn-taking")$ods_mph),2)
round(median(subset(quantity.nonrand.bychild, sample == "turn-taking")$ods_mph),2)
round(min(subset(quantity.nonrand.bychild, sample == "turn-taking")$ods_mph),2)
round(max(subset(quantity.nonrand.bychild, sample == "turn-taking")$ods_mph),2)

```


## Vocal maturity
``` {r vocmat_prep, message=FALSE, warning=FALSE, paged.print=FALSE}
# all vocalization types
chi.vm.lx.utts <- all.data %>%
  filter((tier == "vcm@CHI" | tier == "lex@CHI" | tier == "mwu@CHI") & !is.na(val)) %>%
  mutate(voc.rating = ifelse(val == "M", 4,
                             ifelse((val == "1" | val == "W"), 3,
                                    ifelse((val == "0" | val == "C"), 2,
                                           ifelse(val == "N", 1, 0))))) %>%
  filter(voc.rating > 0) %>%
  group_by(aclew_child_id, segment, sample, start) %>%
  summarise(max_voc.rtg = max(voc.rating))
all.voc.types.per.child <- tibble(
  aclew_child_id = rep(ptcp.info$aclew_child_id, 4),
  max_voc.rtg = c(rep(1, length(ptcp.info$aclew_child_id)),
                  rep(2, length(ptcp.info$aclew_child_id)),
                  rep(3, length(ptcp.info$aclew_child_id)),
                  rep(4, length(ptcp.info$aclew_child_id)))
)
chi.nvocs <- chi.vm.lx.utts %>%
  group_by(aclew_child_id) %>%
  summarise(n_vocs = n())
chi.vm.lx.voc.type.props <- chi.vm.lx.utts %>%
  group_by(aclew_child_id, max_voc.rtg) %>%
  summarise(n_voc.type = n()) %>%
  full_join(all.voc.types.per.child, by = c("aclew_child_id", "max_voc.rtg")) %>%
  replace_na(list(n_voc.type = 0)) %>%
  full_join(chi.nvocs, by = "aclew_child_id") %>%
  mutate(prop_voc.type = round(n_voc.type/n_vocs, 3)) %>%
  arrange(aclew_child_id, max_voc.rtg) %>%
  full_join(ptcp.info, by = "aclew_child_id")

# speech-like vs. non-speech-like only, only under 19mo
chi.vm.lx.utts.all <- all.data %>%
  filter((tier == "vcm@CHI" | tier == "lex@CHI" | tier == "mwu@CHI") &
           !is.na(val) & age_mo_round < 19) %>%
  mutate(voc.rating = ifelse(val == "M", 1,
                             ifelse((val == "1" | val == "W"), 1,
                                    ifelse((val == "0" | val == "C"), 1, 0)))) %>%
  group_by(aclew_child_id, segment, sample, start) %>%
  summarise(max_voc.rtg = max(voc.rating))
all.voc.types.per.child.all <- tibble(
  aclew_child_id = rep(ptcp.info$aclew_child_id, 2),
  max_voc.rtg = c(rep(0, length(ptcp.info$aclew_child_id)),
                  rep(1, length(ptcp.info$aclew_child_id)))
)
chi.nvocs.all <- chi.vm.lx.utts.all %>%
  group_by(aclew_child_id) %>%
  summarise(n_vocs = n())
chi.vm.lx.voc.type.props.bin <- chi.vm.lx.utts.all %>%
  group_by(aclew_child_id, max_voc.rtg) %>%
  summarise(n_voc.type = n()) %>%
  left_join(all.voc.types.per.child.all, by = c("aclew_child_id", "max_voc.rtg")) %>%
  replace_na(list(n_voc.type = 0)) %>%
  left_join(chi.nvocs.all, by = "aclew_child_id") %>%
  mutate(prop_voc.type = round(n_voc.type/n_vocs, 3)) %>%
  arrange(aclew_child_id, max_voc.rtg) %>%
  left_join(ptcp.info, by = "aclew_child_id")
```

``` {r vocmat_plots, message=FALSE, warning=FALSE, paged.print=FALSE}
chi.vm.lx.voc.type.props <- chi.vm.lx.voc.type.props %>%
  mutate(voc.type = factor(as.factor(max_voc.rtg),
                           labels = c("NCB", "CB", "SW", "MW")))
write_csv(chi.vm.lx.voc.type.props,
          paste0(shiny.input.path,
                 "all_vocmat-types_proportions.csv"))
voc.mat.by.age <- ggplot(
  data = chi.vm.lx.voc.type.props,
  aes(x = age_mo_round, y = prop_voc.type, group = as.factor(voc.type))) +
  geom_point(aes(color = as.factor(voc.type))) +
  geom_smooth(aes(color = as.factor(voc.type),
                  fill = as.factor(voc.type)), method = "loess") +
  ylab("Prop of linguistic vocs") + xlab("Child age (mo)") +
  labs(fill='Voc type') +
  labs(color='Voc type') +
  scale_color_manual(values = c("gray80", "gray54",
                                  "gray27", "black")) +
  scale_fill_manual(values = c("gray80", "gray54",
                                  "gray27", "black")) +
  scale_y_continuous(limits=c(-0.5,1.5),
                     breaks=seq(0,1,0.2)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,1), xlim=c(0,38)) +
  theme_apa() + theme(
    legend.position = c(0.9, 0.85),
    legend.background = element_rect(fill="transparent"),
    axis.line = element_line(color="black", size = 0.4))

voc.mat.by.age.1 <- ggplot(
    data = subset(chi.vm.lx.voc.type.props, voc.type == "NCB"),
    aes(x = age_mo_round, y = prop_voc.type)) +
  geom_point(color = "red") +
  geom_smooth(color = "red", fill = "red", method = "loess") +
  ylab("Prop of linguistic vocs") + xlab("Child age (mo)") +
  scale_y_continuous(limits=c(-0.5,1.5),
                     breaks=seq(0,1,0.2)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,1), xlim=c(0,38)) +
  theme_apa() +
  basic.theme + theme(
	panel.grid.major = element_blank(),
	panel.grid.minor = element_blank(),
	axis.text.x = element_text(color="black"),
	axis.title.x = element_text(color="black"),
	axis.text.y = element_text(color="black"),
	axis.title.y = element_text(color="black"),
	strip.text = element_text(color="black"),
	axis.ticks = element_line(color = "black"),
	axis.line = element_line(color="black", size = 0.4),
	legend.position = "none")

voc.mat.by.age.2 <- ggplot(
    data = subset(chi.vm.lx.voc.type.props, voc.type == "CB"),
    aes(x = age_mo_round, y = prop_voc.type)) +
  geom_point(color = "orange") +
  geom_smooth(color = "orange", fill = "orange", method = "loess") +
  ylab("Prop of linguistic vocs") + xlab("Child age (mo)") +
  scale_y_continuous(limits=c(-0.5,1.5),
                     breaks=seq(0,1,0.2)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,1), xlim=c(0,38)) +
  theme_apa() +
  basic.theme + theme(
	panel.grid.major = element_blank(),
	panel.grid.minor = element_blank(),
	axis.text.x = element_text(color="black"),
	axis.title.x = element_text(color="black"),
	axis.text.y = element_text(color="black"),
	axis.title.y = element_text(color="black"),
	strip.text = element_text(color="black"),
	axis.ticks = element_line(color = "black"),
	axis.line = element_line(color="black", size = 0.4),
	legend.position = "none")

voc.mat.by.age.3 <- ggplot(
    data = subset(chi.vm.lx.voc.type.props, voc.type == "SW"),
    aes(x = age_mo_round, y = prop_voc.type)) +
  geom_point(color = "green") +
  geom_smooth(color = "green", fill = "green", method = "loess") +
  ylab("Prop of linguistic vocs") + xlab("Child age (mo)") +
  scale_y_continuous(limits=c(-0.5,1.5),
                     breaks=seq(0,1,0.2)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,1), xlim=c(0,38)) +
  theme_apa() +
  basic.theme + theme(
	panel.grid.major = element_blank(),
	panel.grid.minor = element_blank(),
	axis.text.x = element_text(color="black"),
	axis.title.x = element_text(color="black"),
	axis.text.y = element_text(color="black"),
	axis.title.y = element_text(color="black"),
	strip.text = element_text(color="black"),
	axis.ticks = element_line(color = "black"),
	axis.line = element_line(color="black", size = 0.4),
	legend.position = "none")

voc.mat.by.age.4 <- ggplot(
    data = subset(chi.vm.lx.voc.type.props, voc.type == "MW"),
    aes(x = age_mo_round, y = prop_voc.type)) +
  geom_point(color = "blue") +
  geom_smooth(color = "blue", fill = "blue", method = "loess") +
  ylab("Prop of linguistic vocs") + xlab("Child age (mo)") +
  scale_y_continuous(limits=c(-0.5,1.5),
                     breaks=seq(0,1,0.2)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,1), xlim=c(0,38)) +
  theme_apa() +
  basic.theme + theme(
	panel.grid.major = element_blank(),
	panel.grid.minor = element_blank(),
	axis.text.x = element_text(color="black"),
	axis.title.x = element_text(color="black"),
	axis.text.y = element_text(color="black"),
	axis.title.y = element_text(color="black"),
	strip.text = element_text(color="black"),
	axis.ticks = element_line(color = "black"),
	axis.line = element_line(color="black", size = 0.4),
	legend.position = "none")

png(paste("diff_figs/","vocmat.1.png", sep=""),
    width=600, height=400,units="px", bg = "transparent")
print(voc.mat.by.age.1)
dev.off()
png(paste("diff_figs/","vocmat.2.png", sep=""),
    width=600, height=400,units="px", bg = "transparent")
print(voc.mat.by.age.2)
dev.off()
png(paste("diff_figs/","vocmat.3.png", sep=""),
    width=600, height=400,units="px", bg = "transparent")
print(voc.mat.by.age.3)
dev.off()
png(paste("diff_figs/","vocmat.4.png", sep=""),
    width=600, height=400,units="px", bg = "transparent")
print(voc.mat.by.age.4)
```


```{r fig6, echo=FALSE, fig.cap="Proportion of vocalization types used by children across age (NCB = Non-canonical babble, CB = Canonical babble, SW = single word utterance, MW = multi-word utterance).", message=FALSE, warning=FALSE, fig.height=3.5}
voc.mat.by.age
```

# Acknowledgements {#acknowledgements}
This paper was written using the papaja library in RStudio [@R-papaja].

\newpage

# References {#refs}

```{r create_r-references}
r_refs(file = "Yeli-CLE.bib")
```

\begingroup
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}

<div id = "refs"></div>
\endgroup
